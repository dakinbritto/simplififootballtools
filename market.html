<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simplifi Football Markets</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen bg-black text-gray-300" style="font-family: Inter">

<!-- Loading -->
<div id="loading" class="flex items-center justify-center min-h-screen">
  <div class="text-center animate-pulse">
    <div class="text-emerald-400 text-xl mb-2">Loading Markets…</div>
    <div class="text-gray-500 text-sm">Analyzing data securely</div>
  </div>
</div>

<!-- Error -->
<div id="error" class="hidden flex items-center justify-center min-h-screen">
  <div class="text-center text-red-400">
    Error loading markets
  </div>
</div>

<!-- App -->
<div id="app" class="hidden min-h-screen">

<main class="max-w-7xl mx-auto px-4 py-6">

  <h2 class="text-2xl font-semibold text-white mb-4">
    Available Football Markets
  </h2>

  <!-- Controls -->
  <div class="flex gap-3 mb-6">
    <select id="filterStrategy" class="bg-black border border-neutral-800 px-3 py-2 rounded">
      <option value="all">All Strategies</option>
      <option value="over">Over 2.5 Goals</option>
      <option value="under">Under 2.5 Goals</option>
      <option value="under6">Under 6 Goals</option>
    </select>

    <select id="filterPerformance" class="bg-black border border-neutral-800 px-3 py-2 rounded">
      <option value="all">All Performance</option>
      <option value="profitable">Profitable Only</option>
      <option value="losing">Losing Only</option>
    </select>
  </div>

  <!-- Markets -->
  <section class="border border-neutral-800 rounded-xl overflow-hidden">
    <div id="marketsList" class="divide-y divide-neutral-900"></div>
  </section>

</main>
</div>

<script>
let allMarkets = []

/* =========================
   LOAD FROM FIREBASE
========================= */
async function loadSecureMarkets() {
  try {
    const res = await fetch(
      'https://us-central1-simplififootball-1234.cloudfunctions.net/api/markets/all'
    )

    if (!res.ok) throw new Error('Fetch failed')

    const data = await res.json()
    allMarkets = data.markets

    renderMarkets()
    showApp()
  } catch (e) {
    console.error(e)
    showError()
  }
}

/* =========================
   RENDER
========================= */
function renderMarkets() {
  const container = document.getElementById('marketsList')
  container.innerHTML = ''

  getFilteredMarkets().forEach(market => {
    const row = document.createElement('div')
    row.className = 'p-4 hover:bg-neutral-900 cursor-pointer'

    const gamesInfo =
      market.strategy === 'under6'
        ? `${market.totalTrades} trades`
        : `${market.totalGames} games`

    row.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="text-white font-medium">
            ${market.name} (${market.league})
          </div>
          <div class="text-sm text-gray-500">
            ${gamesInfo} • Win rate ${market.winRate.toFixed(1)}%
          </div>
        </div>
        <div class="text-right">
          <div class="text-white">
  ${(market.avgOdds ?? 0).toFixed(2)}
</div>
          <div class="${market.roi >= 0 ? 'text-emerald-400' : 'text-red-400'}">
            ${market.roi.toFixed(1)}%
          </div>
        </div>
      </div>
    `

    row.onclick = () => {
      window.open(
        `https://www.simplififootball.com/investment-calculator.html?league=${encodeURIComponent(market.league)}&strategy=${market.strategy}`,
        '_blank'
      )
    }

    container.appendChild(row)
  })
}

/* =========================
   FILTERS
========================= */
function getFilteredMarkets() {
  let result = [...allMarkets]

  const strategy = filterStrategy.value
  const perf = filterPerformance.value

  if (strategy !== 'all')
    result = result.filter(m => m.strategy === strategy)

  if (perf === 'profitable')
    result = result.filter(m => m.roi > 0)
  if (perf === 'losing')
    result = result.filter(m => m.roi < 0)

  return result.sort((a,b) => b.roi - a.roi)
}

/* =========================
   UI HELPERS
========================= */
function showApp() {
  loading.style.display = 'none'
  app.style.display = 'block'
  lucide.createIcons()
}

function showError() {
  loading.style.display = 'none'
  error.style.display = 'flex'
}

/* =========================
   EVENTS
========================= */
filterStrategy.onchange = renderMarkets
filterPerformance.onchange = renderMarkets

document.addEventListener('DOMContentLoaded', loadSecureMarkets)
</script>

</body>
</html>
