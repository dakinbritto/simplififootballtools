<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Strategy Backtest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#0b0f14] font-sans text-zinc-200 flex flex-col opacity-0 animate-[fadeIn_0.6s_ease-in-out_forwards]" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji;">

  <!-- Loading Screen -->
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center animate-pulse">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-yellow-400 mb-3">
        <span class="relative inline-flex">
          <i data-lucide="loader-2" class="w-5 h-5 mr-1 animate-spin"></i>
          <i data-lucide="football" class="w-5 h-5 absolute -right-6 top-0 opacity-60"></i>
        </span>
        <span>Loading team data...</span>
      </div>
      <div class="text-sm text-zinc-500">Calculating team popularity metrics...</div>
    </div>
  </div>

  <!-- Error Screen -->
  <div id="error" class="flex items-center justify-center min-h-screen" style="display: none;">
    <div class="text-center bg-[#10151c] border border-red-900/40 rounded-xl px-6 py-5 shadow-sm">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-red-400 mb-2">
        <i data-lucide="triangle-alert" class="w-5 h-5"></i>
        <span>Error loading data</span>
      </div>
      <div class="text-sm text-zinc-400 mb-2">Please check:</div>
      <ul class="text-xs text-zinc-500 text-left inline-block space-y-1">
        <li>• MAINRAW.csv is accessible</li>
        <li>• Check browser console for errors</li>
      </ul>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header class="w-full border-b border-zinc-800/80 bg-[#0f141b]/60 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 py-6 md:py-7 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-yellow-600/10 ring-1 ring-yellow-600/20">
            <i data-lucide="line-chart" class="w-5 h-5 text-yellow-500"></i>
          </span>
          <h1 class="text-2xl md:text-3xl font-semibold italic text-yellow-500 tracking-tight">Test your strategy</h1>
        </div>
        <!-- Moved Filters -->
        <div class="w-full md:w-auto grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-zinc-400 mb-1">Market</label>
            <div class="relative">
              <button id="marketDropdownBtn" class="w-full inline-flex items-center justify-between gap-x-2 text-xs font-medium text-zinc-300 hover:text-zinc-100 focus:outline-none focus:ring-2 focus:ring-yellow-500/30 rounded-md px-3 py-2 transition-all bg-[#111821] border border-zinc-800">
                <span class="inline-flex items-center gap-2">
                  <i data-lucide="target" class="w-4 h-4 text-yellow-500"></i>
                  <span id="selectedMarket" class="font-semibold tracking-tight">OVER 2.5 GOALS</span>
                </span>
                <i data-lucide="chevron-down" class="w-4 h-4"></i>
              </button>
              <div id="marketMenu" class="hidden absolute left-0 mt-2 w-64 bg-[#0f141b] rounded-lg shadow-xl ring-1 ring-zinc-800 z-10 border border-zinc-800/80">
                <div class="max-h-64 overflow-y-auto py-1">
                  <ul id="marketList" class="py-1 text-xs">
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="OVER 2.5 GOALS" data-value="over2.5">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2 text-yellow-500"></i>OVER 2.5 GOALS
                      </button>
                    </li>
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="UNDER 2.5 GOALS" data-value="under2.5">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-2 text-indigo-400"></i>UNDER 2.5 GOALS
                      </button>
                    </li>
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="UNDER 6 GOALS" data-value="under6">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-2 text-purple-400"></i>UNDER 6 GOALS
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-zinc-400 mb-1">Start From Season</label>
            <div class="relative">
              <i data-lucide="calendar" class="w-4 h-4 text-zinc-500 absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              <select id="seasonFilter" class="w-full bg-[#111821] text-white text-sm pl-7 pr-2 py-2 rounded-md border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-yellow-500/30">
                <option value="all">All Seasons</option>
              </select>
            </div>
          </div>
        </div>
        <!-- End Moved Filters -->
      </div>
    </header>

    <main class="flex-1 py-6 pb-20">
      <section class="max-w-7xl mx-auto px-4 animate-[slideInUp_1s_ease-in-out_0.2s_forwards] opacity-0">
  <!-- Getting Started - Dark Panel -->
      <div class="mb-8 bg-gradient-to-br from-[#161c23] via-[#0f1617] to-[#004e2b] p-6 rounded-2xl shadow-innerBorder border border-zinc-900/40 text-zinc-200">
        <h2 class="text-lg font-semibold mb-3">Getting Started</h2>
        <p class="text-sm text-zinc-400 leading-relaxed">
          Choose your favorite teams from the leagues below to begin backtesting the selected market strategy.
          We'll analyze historical data to show how your selected teams have performed with this market.
        </p>
      </div>
        <!-- Teams Section Header -->
        <h2 class="text-xl font-semibold mb-4 uppercase tracking-tight border-b border-zinc-800/80 pb-2 bg-gradient-to-r from-[#0e1216] via-[#0b0f14] to-[#0c2620] rounded-t-xl px-4 py-3 -mx-4 text-zinc-300">
          Select Teams for Your Strategy
        </h2>

        <!-- Horizontal Scrolling Leagues Container -->
        <div class="relative mb-6">
          <div id="leaguesContainer" class="flex gap-4 overflow-x-auto pb-4 scroll-smooth">
            <!-- Leagues will be populated here -->
          </div>

          <!-- Gradient edge indicators -->
          <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-[#0b0f14] to-transparent"></div>
          <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-[#0b0f14] to-transparent"></div>

          <!-- Scroll indicators -->
          <button id="scrollLeft" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#111821] border border-zinc-800 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-[#16202b] transition-colors shadow-sm z-10" style="display: none;">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <button id="scrollRight" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#111821] border border-zinc-800 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-[#16202b] transition-colors shadow-sm z-10">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="space-y-6" style="display: none;">

          <!-- Performance Summary -->
          <div class="bg-gradient-to-br from-[#0f141b] via-[#0d1319] to-[#0a2a1b] rounded-xl p-5 md:p-6 border border-zinc-900/50">
            <div class="flex items-center gap-3 mb-4">
              <span class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-yellow-600/10 ring-1 ring-yellow-600/20">
                <i data-lucide="trending-up" class="w-4 h-4 text-yellow-400"></i>
              </span>
              <h2 class="text-xl tracking-tight font-semibold text-white">Backtest Results</h2>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">Total Games</div>
                <div id="statGames" class="text-white font-mono text-lg">0</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">Win Rate</div>
                <div id="statWinRate" class="text-white font-mono text-lg">0%</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">ROI</div>
                <div id="statROI" class="font-mono text-lg">0%</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">Final Capital</div>
                <div id="statFinalCapital" class="font-mono text-lg">£0</div>
              </div>
            </div>

            <div class="h-0.5 bg-zinc-800/60 rounded mb-5"></div>

            <!-- Chart -->
            <div class="relative">
              <div class="h-80 relative rounded-lg border border-zinc-800 bg-[#0b1016]">
                <div class="absolute inset-0 rounded-lg pointer-events-none" style="background-image: radial-gradient(circle at 20% 20%, rgba(234,179,8,0.06), transparent 40%), radial-gradient(circle at 80% 0%, rgba(99,102,241,0.06), transparent 40%);"></div>
                <canvas id="capitalChart" class="w-full h-full"></canvas>
              </div>
            </div>
          </div>

          <!-- Selected Teams Info -->
          <div id="selectedTeamsInfo" class="bg-[#0f141b] border border-zinc-900/60 p-4 rounded-lg">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="list-checks" class="w-4 h-4 text-yellow-500"></i>
              <h3 class="font-semibold text-yellow-400">Selected Teams Analysis</h3>
            </div>
            <div id="selectedTeamsList" class="text-sm text-zinc-300"></div>
          </div>

        </div>

      </section>
    </main>
 <!-- How it works - Dark Panel -->
      <div class="bg-gradient-to-br from-[#161c23] via-[#0f1617] to-[#004e2b] border border-zinc-900/40 rounded-2xl p-5 shadow-innerBorder mb-8 animate-[fadeIn_0.8s_ease-in-out_1.2s_forwards] opacity-0">
        <div class="flex items-center gap-2 mb-4">
          <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
          <h3 class="text-lg font-semibold text-zinc-200">How it works</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <p class="text-sm leading-relaxed text-zinc-400">
            Select your favorite teams from the leagues above. These teams will be analyzed against the chosen market strategy.
            We'll show you historical performance data to help you identify profitable patterns and optimize your betting strategy.
          </p>
          <p class="text-sm leading-relaxed text-zinc-400">
            After selecting your teams, click the "Next" button to proceed to the main backtesting tool where you can see detailed statistics,
            performance metrics, and recommendations based on your selections.
          </p>
        </div>
      </div>

    <!-- Selected Teams + Run Button Row -->
    <div class="max-w-7xl mx-auto px-4 mt-2 mb-6 flex flex-col sm:flex-row sm:items-end justify-between gap-4">
      <div>
        <label class="block text-xs font-medium text-zinc-400 mb-1">Selected Teams</label>
        <div class="flex items-center gap-2 bg-[#111821] border border-zinc-800 rounded-md px-3 py-2">
          <i data-lucide="users" class="w-4 h-4 text-yellow-500"></i>
          <div id="selectedCount" class="text-sm font-medium text-yellow-400">0 teams</div>
        </div>
      </div>
      <div class="sm:justify-self-end">
        <button id="runBacktest" class="inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold rounded-md text-zinc-900 bg-yellow-600 hover:bg-yellow-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-yellow-600">
          <i data-lucide="play" class="w-4 h-4"></i>
          Run Backtest
        </button>
      </div>
    </div>

    <footer class="bg-gradient-to-br from-[#0f141b] via-[#0d1319] to-[#0a2a1b] border-t border-zinc-900/60 py-4 animate-[fadeIn_1s_ease-in-out_1.6s_forwards] opacity-0">
      <div class="max-w-7xl mx-auto px-4 text-center text-xs text-zinc-500">
        <p>Select your teams above to begin analyzing market performance and optimize your strategy</p>
      </div>
    </footer>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#0f141b] border-t border-zinc-800 z-50">
    <div class="max-w-md mx-auto">
      <div class="flex">
        <!-- Markets -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-zinc-400 hover:text-zinc-200 transition-colors" data-nav="markets">
          <i data-lucide="trending-up" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Markets</span>
        </button>
        
        <!-- Backtesting (Active) -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-yellow-500 transition-colors">
          <i data-lucide="line-chart" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Backtesting</span>
          <div class="w-1 h-1 bg-yellow-500 rounded-full mt-1"></div>
        </button>
        
        <!-- Journal -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-zinc-400 hover:text-zinc-200 transition-colors" data-nav="journal">
          <i data-lucide="book-open" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Journal</span>
        </button>
      </div>
    </div>
  </nav>

  <style>
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes slideInLeft {
      0% { opacity: 0; transform: translateX(-20px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .shadow-innerBorder { box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }

    /* Horizontal scroll styling */
    #leaguesContainer { scrollbar-width: thin; scrollbar-color: #374151 #1f2937; }
    #leaguesContainer::-webkit-scrollbar { height: 6px; }
    #leaguesContainer::-webkit-scrollbar-track { background: #1f2937; border-radius: 3px; }
    #leaguesContainer::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    #leaguesContainer::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    /* Team card styling */
    .team-card { transition: all 0.2s ease; }
    .team-card:hover { transform: translateY(-1px); border-color: #eab308; background: rgba(234,179,8,0.02); }
    .team-card.selected { background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(202, 138, 4, 0.08)); border-color: #eab308; }
  </style>

  <script>
    // Global variables
    let csvData = null;
    let teamPopularity = {};
    let selectedTeams = new Set();
    let processedData = [];
    let chart = null;
    let currentMarket = 'over2.5';

    const gbp0 = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 });
    const gbp2 = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // League -> flag mapping (broad coverage of known leagues)
    const leagueFlagMap = [
      // Specific overrides and abbreviations
      { code: 'gb-eng', keys: ['epl', 'english premier league', 'english premiership'] }, // England flag for EPL
      { code: 'gb', keys: ['england', 'premier league', 'championship', 'league one', 'league two', 'fa cup', 'efl'] },
      { code: 'gb-sct', keys: ['scotland', 'scottish'] },
      { code: 'ie', keys: ['ireland', 'league of ireland', 'eircom'] },
      { code: 'es', keys: ['spain', 'la liga', 'laliga', 'segunda'] },
      { code: 'it', keys: ['italy', 'serie a', 'serie b', 'seriab', 'coppa italia'] }, // add SeriaB alias
      { code: 'de', keys: ['germany', 'bundesliga', 'zweite bundesliga', 'bundes2', 'dfb-pokal'] }, // add Bundes2 alias
      { code: 'fr', keys: ['france', 'ligue 1', 'ligue 2', 'le championnat', 'coupe de france'] }, // add Le Championnat alias
      { code: 'nl', keys: ['netherlands', 'eredivisie', 'eerste divisie', 'keuken kampioen', 'knvb'] },
      { code: 'pt', keys: ['portugal', 'primeira', 'liga portugal', 'taca de portugal'] },
      { code: 'tr', keys: ['turkey', 'süper lig', 'super lig', 'turkiye'] },
      { code: 'be', keys: ['belgium', 'pro league', 'jupiler'] },
      { code: 'at', keys: ['austria', 'admiral bundesliga'] },
      { code: 'ch', keys: ['switzerland', 'swiss super league'] },
      { code: 'dk', keys: ['denmark', 'superliga'] },
      { code: 'no', keys: ['norway', 'eliteserien'] },
      { code: 'se', keys: ['sweden', 'allsvenskan', 'superettan'] },
      { code: 'fi', keys: ['finland', 'veikkausliiga'] },
      { code: 'is', keys: ['iceland', 'úrvalsdeild', 'urvalsdeild'] },
      { code: 'pl', keys: ['poland', 'ekstraklasa'] },
      { code: 'cz', keys: ['czech', 'fortuna liga'] },
      { code: 'sk', keys: ['slovakia', 'niké liga', 'nike liga'] },
      { code: 'hu', keys: ['hungary', 'nb i'] },
      { code: 'ro', keys: ['romania', 'liga i'] },
      { code: 'bg', keys: ['bulgaria', 'parva liga', 'efbet'] },
      { code: 'gr', keys: ['greece', 'super league greece'] },
      { code: 'si', keys: ['slovenia', 'prva liga'] },
      { code: 'hr', keys: ['croatia', 'hnl'] },
      { code: 'rs', keys: ['serbia', 'superliga'] },
      { code: 'ba', keys: ['bosnia', 'premijer liga'] },
      { code: 'me', keys: ['montenegro'] },
      { code: 'mk', keys: ['macedonia', 'north macedonia'] },
      { code: 'al', keys: ['albania', 'kategoria superiore'] },
      { code: 'lt', keys: ['lithuania', 'a lyga'] },
      { code: 'lv', keys: ['latvia', 'virsliga'] },
      { code: 'ee', keys: ['estonia', 'meistriliiga'] },
      { code: 'ua', keys: ['ukraine', 'premier league (ukraine)'] },
      { code: 'ru', keys: ['russia', 'premier liga'] },
      { code: 'cy', keys: ['cyprus', 'first division (cyp)'] },
      { code: 'mt', keys: ['malta', 'premier league (mlt)'] },
      { code: 'lu', keys: ['luxembourg'] },
      { code: 'li', keys: ['liechtenstein'] },
      { code: 'sm', keys: ['san marino'] },
      { code: 'ad', keys: ['andorra'] },
      { code: 'mc', keys: ['monaco'] },

      { code: 'us', keys: ['usa', 'united states', 'mls', 'major league soccer'] },
      { code: 'ca', keys: ['canada', 'cpl', 'premier league (canada)'] },
      { code: 'mx', keys: ['mexico', 'liga mx'] },
      { code: 'br', keys: ['brazil', 'brasileirao', 'serie a (bra)', 'serie b (bra)'] },
      { code: 'ar', keys: ['argentina', 'liga profesional', 'primera división (arg)'] },
      { code: 'co', keys: ['colombia', 'primera a (col)'] },
      { code: 'cl', keys: ['chile', 'primera division (chi)'] },
      { code: 'uy', keys: ['uruguay'] },
      { code: 'py', keys: ['paraguay'] },
      { code: 'pe', keys: ['peru'] },
      { code: 'ec', keys: ['ecuador'] },
      { code: 'bo', keys: ['bolivia'] },
      { code: 've', keys: ['venezuela'] },

      { code: 'jp', keys: ['japan', 'j1 league', 'j-league', 'j2 league'] },
      { code: 'kr', keys: ['korea', 'south korea', 'k league'] },
      { code: 'cn', keys: ['china', 'csl', 'super league (chn)'] },
      { code: 'au', keys: ['australia', 'a-league'] },
      { code: 'nz', keys: ['new zealand'] },
      { code: 'sa', keys: ['saudi', 'saudi arabia', 'pro league (ksa)'] },
      { code: 'ae', keys: ['uae', 'united arab emirates'] },
      { code: 'qa', keys: ['qatar'] },
      { code: 'ir', keys: ['iran', 'persian gulf'] },
      { code: 'il', keys: ['israel'] },
      { code: 'in', keys: ['india', 'isl', 'i-league'] },
      { code: 'id', keys: ['indonesia', 'liga 1 (idn)'] },
      { code: 'my', keys: ['malaysia'] },
      { code: 'th', keys: ['thailand'] },
      { code: 'sg', keys: ['singapore'] },
      { code: 'vn', keys: ['vietnam'] },
      { code: 'ph', keys: ['philippines'] },
      { code: 'hk', keys: ['hong kong'] },
      { code: 'tw', keys: ['taiwan'] },

      { code: 'za', keys: ['south africa', 'premier division (rsa)', 'psl'] },
      { code: 'ng', keys: ['nigeria'] },
      { code: 'gh', keys: ['ghana'] },
      { code: 'cm', keys: ['cameroon'] },
      { code: 'eg', keys: ['egypt'] },
      { code: 'ma', keys: ['morocco', 'botola'] },
      { code: 'dz', keys: ['algeria'] },
      { code: 'tn', keys: ['tunisia'] },

      // UEFA competitions (fallback to EU flag)
      { code: 'eu', keys: ['champions league', 'europa league', 'conference league', 'uefa'] }
    ];

    function getLeagueFlagCode(leagueName) {
      const name = String(leagueName || '').toLowerCase();
      for (const entry of leagueFlagMap) {
        for (const key of entry.keys) {
          if (name.includes(key)) return entry.code;
        }
      }
      return null;
    }

    function getLeagueFlagHTML(leagueName) {
      const code = getLeagueFlagCode(leagueName);
      if (code) {
        const src = `https://flagcdn.com/${code}.svg`;
        return `<div class="h-4 w-6 rounded-[3px] overflow-hidden ring-1 ring-zinc-700/60 bg-zinc-900"><img src="${src}" alt="${leagueName} flag" class="h-full w-full object-cover" loading="lazy"></div>`;
      }
      // Fallback to existing icon if unknown
      return `<span class="inline-flex h-6 w-6 items-center justify-center rounded bg-yellow-600/10 ring-1 ring-yellow-600/20"><i data-lucide="shield" class="h-3.5 w-3.5 text-yellow-400"></i></span>`;
    }

    // Load and parse CSV data
    async function loadData() {
      try {
        const response = await fetch('/MAINRAW.csv', { cache: 'no-cache' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const csvText = await response.text();

        csvData = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        }).data;

        calculateTeamPopularity();
        populateSeasonFilters();
        renderTeamSelection();
        hideLoading();
      } catch (error) {
        console.error('Error loading CSV:', error);
        showError();
      }
    }

    // Calculate team popularity metrics for all markets
    function calculateTeamPopularity() {
      teamPopularity = {};
      const leagues = [...new Set(csvData.map(row => row.League))].filter(Boolean);
      leagues.forEach(league => {
        teamPopularity[league] = {};
        const leagueData = csvData.filter(row => row.League === league);
        const teams = [...new Set([
          ...leagueData.map(row => row.HomeTeam),
          ...leagueData.map(row => row.AwayTeam)
        ])].filter(Boolean);

        teams.forEach(team => {
          const teamMatches = leagueData.filter(row => row.HomeTeam === team || row.AwayTeam === team);
          if (teamMatches.length > 0) {
            const validMatches = teamMatches.filter(match => !isNaN(getTotalGoals(match)));
            const over25Count = validMatches.filter(match => getTotalGoals(match) > 2).length;
            const under25Count = validMatches.filter(match => getTotalGoals(match) <= 2).length;
            const under6Count = validMatches.filter(match => getTotalGoals(match) < 6).length;

            teamPopularity[league][team] = {
              over25Percentage: validMatches.length > 0 ? (over25Count / validMatches.length) * 100 : 0,
              under25Percentage: validMatches.length > 0 ? (under25Count / validMatches.length) * 100 : 0,
              under6Percentage: validMatches.length > 0 ? (under6Count / validMatches.length) * 100 : 0,
              totalMatches: teamMatches.length,
              validMatches: validMatches.length,
              over25Count,
              under25Count,
              under6Count
            };
          }
        });
      });
    }

    // Helper function to get total goals
    function getTotalGoals(row) {
      const toNum = (v) => {
        if (typeof v === 'number') return v;
        if (typeof v === 'string' && v.trim() !== '') {
          const n = Number(v);
          return isNaN(n) ? NaN : n;
        }
        return NaN;
      };

      const homeKeys = ['FTHG', 'HomeGoals', 'HG', 'home_goals', 'FHG', 'HomeG'];
      const awayKeys = ['FTAG', 'AwayGoals', 'AG', 'away_goals', 'FAG', 'AwayG'];

      let h = NaN, a = NaN;
      for (const k of homeKeys) { if (k in row) { h = toNum(row[k]); break; } }
      for (const k of awayKeys) { if (k in row) { a = toNum(row[k]); break; } }
      if (!isNaN(h) && !isNaN(a)) return h + a;
      return NaN;
    }

    // Populate season filters
    function populateSeasonFilters() {
      const seasons = [...new Set(csvData.map(row => row.Season))].filter(Boolean).sort();
      const seasonFilter = document.getElementById('seasonFilter');
      seasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = season.toUpperCase();
        seasonFilter.appendChild(option);
      });
    }

    // Helper function to get seasons from a starting season onwards
    function getSeasonsFromStarting(startingSeason, allSeasons) {
      if (startingSeason === 'all') return allSeasons;
      const sortedSeasons = allSeasons.sort();
      const startIndex = sortedSeasons.indexOf(startingSeason);
      return startIndex >= 0 ? sortedSeasons.slice(startIndex) : [];
    }

    // Get filtered teams based on current filters
    function getFilteredTeams() {
      const seasonFilter = document.getElementById('seasonFilter').value;
      let filteredData = csvData;

      if (seasonFilter !== 'all') {
        const allSeasons = [...new Set(csvData.map(row => row.Season))].filter(Boolean);
        const seasonsToInclude = getSeasonsFromStarting(seasonFilter, allSeasons);
        filteredData = csvData.filter(row => seasonsToInclude.includes(row.Season));
      }

      const filteredPopularity = {};
      const leagues = [...new Set(filteredData.map(row => row.League))].filter(Boolean);

      leagues.forEach(league => {
        filteredPopularity[league] = {};
        const leagueData = filteredData.filter(row => row.League === league);
        const teams = [...new Set([
          ...leagueData.map(row => row.HomeTeam),
          ...leagueData.map(row => row.AwayTeam)
        ])].filter(Boolean);

        teams.forEach(team => {
          const teamMatches = leagueData.filter(row => row.HomeTeam === team || row.AwayTeam === team);
          if (teamMatches.length > 0) {
            const validMatches = teamMatches.filter(match => !isNaN(getTotalGoals(match)));
            if (validMatches.length > 0) {
              const over25Count = validMatches.filter(match => getTotalGoals(match) > 2).length;
              const under25Count = validMatches.filter(match => getTotalGoals(match) <= 2).length;
              const under6Count = validMatches.filter(match => getTotalGoals(match) < 6).length;

              filteredPopularity[league][team] = {
                over25Percentage: (over25Count / validMatches.length) * 100,
                under25Percentage: (under25Count / validMatches.length) * 100,
                under6Percentage: (under6Count / validMatches.length) * 100,
                totalMatches: teamMatches.length,
                validMatches: validMatches.length,
                over25Count,
                under25Count,
                under6Count
              };
            }
          }
        });
      });

      return filteredPopularity;
    }

    // Render team selection interface with horizontal scrolling
    function renderTeamSelection() {
      const container = document.getElementById('leaguesContainer');
      const filteredPopularity = getFilteredTeams();
      container.innerHTML = '';

      let getPercentage, sortOrder;

      if (currentMarket === 'over2.5') {
        getPercentage = (stats) => stats.over25Percentage;
        sortOrder = (a, b) => b[1].over25Percentage - a[1].over25Percentage;
      } else if (currentMarket === 'under2.5') {
        getPercentage = (stats) => stats.under25Percentage;
        sortOrder = (a, b) => b[1].under25Percentage - a[1].under25Percentage;
      } else if (currentMarket === 'under6') {
        getPercentage = (stats) => stats.under6Percentage;
        sortOrder = (a, b) => b[1].under6Percentage - a[1].under6Percentage;
      }

      Object.keys(filteredPopularity).forEach(league => {
        const teams = filteredPopularity[league];
        const sortedTeams = Object.entries(teams).sort(sortOrder);
        if (sortedTeams.length === 0) return;

        const leagueCard = document.createElement('div');
        leagueCard.className = 'bg-[#0f141b] p-4 rounded-lg shadow-sm border border-zinc-900/60 min-w-[280px] flex-shrink-0';

        leagueCard.innerHTML = `
          <div class="flex items-center gap-2 mb-3">
            ${getLeagueFlagHTML(league)}
            <h3 class="text-sm font-semibold text-zinc-200">${league}</h3>
            <span class="text-[11px] text-zinc-400 bg-[#111821] border border-zinc-800 px-2 py-0.5 rounded">${sortedTeams.length}</span>
          </div>
          <div class="space-y-2 max-h-64 overflow-y-auto pr-1">
            ${sortedTeams.map(([team, stats]) => {
              const isSelected = selectedTeams.has(`${league}:${team}`);
              return `
                <label class="team-card flex items-center justify-between p-2 border border-zinc-800 rounded cursor-pointer ${isSelected ? 'selected' : ''}" data-team="${team}" data-league="${league}">
                  <div class="flex items-center gap-2">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} class="rounded border-zinc-700 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0 w-3.5 h-3.5 bg-[#0b1016]">
                    <div>
                      <div class="text-xs font-medium text-white tracking-tight">${team}</div>
                      <div class="text-[11px] text-zinc-500">${stats.validMatches}m</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs font-mono text-yellow-400">${getPercentage(stats).toFixed(1)}%</div>
                  </div>
                </label>
              `;
            }).join('')}
          </div>
        `;

        container.appendChild(leagueCard);
      });

      // Update scroll button visibility
      updateScrollButtons();

      // Add event listeners for team selection
      container.addEventListener('change', handleTeamSelection);

      // Initialize lucide icons
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }
    }

    // Update scroll button visibility
    function updateScrollButtons() {
      const container = document.getElementById('leaguesContainer');
      const scrollLeft = document.getElementById('scrollLeft');
      const scrollRight = document.getElementById('scrollRight');

      const canScrollLeft = container.scrollLeft > 0;
      const canScrollRight = container.scrollLeft < (container.scrollWidth - container.clientWidth) - 1;

      scrollLeft.style.display = canScrollLeft ? 'flex' : 'none';
      scrollRight.style.display = canScrollRight ? 'flex' : 'none';
    }

    // Handle team selection
    function handleTeamSelection(event) {
      if (event.target.type === 'checkbox') {
        const label = event.target.closest('.team-card');
        const team = label.dataset.team;
        const league = label.dataset.league;
        const teamKey = `${league}:${team}`;

        if (event.target.checked) {
          selectedTeams.add(teamKey);
          label.classList.add('selected');
        } else {
          selectedTeams.delete(teamKey);
          label.classList.remove('selected');
        }
        updateSelectedCount();
      }
    }

    // Update selected count and enable/disable backtest button
    function updateSelectedCount() {
      const count = selectedTeams.size;
      document.getElementById('selectedCount').textContent = `${count} team${count !== 1 ? 's' : ''}`;
      const btn = document.getElementById('runBacktest');
      if (btn) btn.disabled = count === 0;
    }

    // Run backtest for selected teams
    function runBacktest() {
      if (selectedTeams.size === 0) return;

      const startingCapital = 1000;
      const stakePercentage = 5;
      const seasonFilter = document.getElementById('seasonFilter').value;

      // Apply season filtering first
      let seasonFilteredData = csvData;
      if (seasonFilter !== 'all') {
        const allSeasons = [...new Set(csvData.map(row => row.Season))].filter(Boolean);
        const seasonsToInclude = getSeasonsFromStarting(seasonFilter, allSeasons);
        seasonFilteredData = csvData.filter(row => seasonsToInclude.includes(row.Season));
      }

      // Then filter by selected teams
      let filteredData = seasonFilteredData.filter(row => {
        const homeTeamKey = `${row.League}:${row.HomeTeam}`;
        const awayTeamKey = `${row.League}:${row.AwayTeam}`;
        return selectedTeams.has(homeTeamKey) || selectedTeams.has(awayTeamKey);
      });

      filteredData = filteredData
        .map(row => ({ ...row, tradeNumber: parseInt(String(row.Trade || '').replace('t', '')) || 0 }))
        .filter(row => row.tradeNumber > 0)
        .sort((a, b) => a.tradeNumber - b.tradeNumber);

      processedData = processInvestmentData(filteredData, startingCapital, stakePercentage, currentMarket);

      const stats = calculateStats(processedData, startingCapital);
      updateResults(stats);
      updateChart(stats, startingCapital);
      showSelectedTeamsInfo();

      document.getElementById('resultsSection').style.display = 'block';
    }

    // Process data for investment calculation
    function processInvestmentData(data, startingCapital, stakePercentage, market) {
      const stakeAmount = (startingCapital * stakePercentage) / 100;
      let runningCapital = startingCapital;

      // Handle Under 6 Goals market with grouping logic
      if (market === 'under6') {
        const groupedTrades = [];

        // Group fixtures into sets of 3
        for (let i = 0; i < data.length; i += 3) {
          const group = data.slice(i, i + 3);
          
          // Only process complete groups of 3
          if (group.length === 3) {
            // Check if all 3 fixtures are under 6 goals
            let allUnder6 = true;
            for (const game of group) {
              const totalGoals = getTotalGoals(game);
              if (isNaN(totalGoals) || totalGoals >= 6) {
                allUnder6 = false;
                break;
              }
            }

            // Use first fixture to represent the trade
            const representativeGame = group[0];
            const odds = parseFloat(representativeGame.odd3) || 0;
            const isWin = allUnder6;
            
            let profit = 0;
            if (isWin && odds > 0) {
              profit = stakeAmount * (odds - 1);
            } else {
              profit = -stakeAmount;
            }

            runningCapital = runningCapital + profit;

            // Create trade entry for the 3-game group
            const tradeEntry = {
              ...representativeGame,
              Trade: `t${groupedTrades.length + 1}`,
              stake: stakeAmount,
              isWin,
              outcome: isWin ? 'win' : 'loss',
              profit,
              capitalMovement: runningCapital,
              gameNumber: groupedTrades.length + 1,
              marketType: 'under6',
              oddsUsed: odds
            };

            groupedTrades.push(tradeEntry);
          }
        }

        return groupedTrades;
      }

      // Handle other markets (over2.5, under2.5) with individual game logic
      return data.map((game, index) => {
        let outcome = 'loss';
        let odds = 0;

        // FIXED: Use corrected logic where 0 = WIN and 1 = LOSS for Over 2.5 Goals
        if (market === 'over2.5') {
          outcome = (game['over2.5goals'] === 0 || game['over2.5goals'] === '0') ? 'win' : 'loss';
          odds = parseFloat(game.odd) || 0;
        } else if (market === 'under2.5') {
          outcome = (game['Under2.5'] === 1 || game['Under2.5'] === '1') ? 'win' : 'loss';
          odds = parseFloat(game.odd2) || 0;
        }

        const isWin = outcome === 'win';
        let profit = 0;
        if (isWin && odds > 0) {
          profit = stakeAmount * (odds - 1);
        } else {
          profit = -stakeAmount;
        }

        runningCapital = runningCapital + profit;

        return {
          ...game,
          stake: stakeAmount,
          isWin,
          outcome,
          profit,
          capitalMovement: runningCapital,
          gameNumber: index + 1,
          marketType: market,
          oddsUsed: odds
        };
      });
    }

    // Calculate statistics
    function calculateStats(data, startingCapital) {
      if (!data.length) {
        return {
          totalGames: 0,
          finalCapital: startingCapital,
          totalReturn: 0,
          winRate: 0,
          maxCapital: startingCapital,
          minCapital: startingCapital,
          roi: 0
        };
      }

      const totalGames = data.length;
      const finalCapital = data[data.length - 1].capitalMovement;
      const totalReturn = finalCapital - startingCapital;
      const wins = data.filter(g => g.isWin).length;
      const winRate = (wins / totalGames) * 100;
      const maxCapital = Math.max(...data.map(g => g.capitalMovement));
      const minCapital = Math.min(...data.map(g => g.capitalMovement));
      const roi = ((totalReturn / startingCapital) * 100);

      return { totalGames, finalCapital, totalReturn, winRate, maxCapital, minCapital, roi };
    }

    // Update results display
    function updateResults(stats) {
      document.getElementById('statGames').textContent = stats.totalGames;
      document.getElementById('statWinRate').textContent = `${stats.winRate.toFixed(1)}%`;

      const roiEl = document.getElementById('statROI');
      const roiPrefix = stats.roi >= 0 ? '+' : '';
      roiEl.textContent = `${roiPrefix}${stats.roi.toFixed(1)}%`;
      roiEl.style.color = stats.roi >= 0 ? '#eab308' : '#ef4444';

      const finalCapitalEl = document.getElementById('statFinalCapital');
      finalCapitalEl.textContent = gbp0.format(Math.round(stats.finalCapital));
      finalCapitalEl.style.color = stats.finalCapital >= 1000 ? '#eab308' : '#ef4444';
    }

    // Update investment chart
    function updateChart(stats, startingCapital) {
      const ctx = document.getElementById('capitalChart').getContext('2d');
      const chartData = processedData.map(d => ({ x: d.gameNumber, y: d.capitalMovement }));

      const lineColor = stats.finalCapital >= startingCapital ? '#eab308' : '#ef4444';
      const fillColor = stats.finalCapital >= startingCapital ? 'rgba(234, 179, 8, 0.1)' : 'rgba(239, 68, 68, 0.1)';

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Capital Movement',
              data: chartData,
              borderColor: lineColor,
              backgroundColor: fillColor,
              borderWidth: 2,
              fill: true,
              tension: 0.2,
              pointRadius: 0,
              pointHoverRadius: 5,
              pointHoverBackgroundColor: lineColor,
              pointHoverBorderColor: '#ffffff',
              pointHoverBorderWidth: 2,
              pointHitRadius: 14
            },
            {
              label: `Starting Capital (${gbp0.format(startingCapital)})`,
              data: [
                { x: 0, y: startingCapital },
                { x: Math.max(chartData.length, 1), y: startingCapital }
              ],
              borderColor: 'rgba(255, 255, 255, 0.25)',
              borderDash: [5, 5],
              borderWidth: 1,
              pointRadius: 0,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: lineColor,
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: (context) => `Game ${context[0].dataIndex + 1}`,
                label: (context) => `Capital: ${gbp0.format(Math.round(context.parsed.y))}`
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              display: true,
              grid: { color: 'rgba(255, 255, 255, 0.08)', drawBorder: false },
              ticks: { color: '#6b7280', maxTicksLimit: 8 },
              title: { display: true, text: 'Game Number', color: '#6b7280' }
            },
            y: {
              display: true,
              grid: { color: 'rgba(255, 255, 255, 0.08)', drawBorder: false },
              ticks: { color: '#6b7280', callback: (v) => gbp0.format(v) },
              title: { display: true, text: 'Capital (£)', color: '#6b7280' }
            }
          }
        }
      });
    }

    // Show selected teams info
    function showSelectedTeamsInfo() {
      const filteredPopularity = getFilteredTeams();
      const teamsList = Array.from(selectedTeams).map(teamKey => {
        const [league, team] = teamKey.split(':');
        const stats = filteredPopularity[league] && filteredPopularity[league][team];
        if (!stats) return `${team} (${league}) - No data`;

        let percentage;
        if (currentMarket === 'over2.5') percentage = stats.over25Percentage;
        else if (currentMarket === 'under2.5') percentage = stats.under25Percentage;
        else percentage = stats.under6Percentage;

        return `${team} (${league}) - ${percentage.toFixed(1)}%`;
      }).join(', ');

      document.getElementById('selectedTeamsList').textContent = teamsList;
    }

    // Visibility helpers
    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('app').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }

      // Market dropdown functionality
      const btn = document.getElementById('marketDropdownBtn');
      const menu = document.getElementById('marketMenu');
      const selectedMarketEl = document.getElementById('selectedMarket');

      btn.addEventListener('click', () => {
        menu.classList.toggle('hidden');
      });

      document.addEventListener('click', e => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add('hidden');
        }
      });

      // Market selection
      const marketButtons = menu.querySelectorAll('button[data-market]');
      marketButtons.forEach(mbtn => {
        mbtn.addEventListener('click', () => {
          currentMarket = mbtn.dataset.value;
          selectedMarketEl.textContent = mbtn.dataset.market;
          menu.classList.add('hidden');
          renderTeamSelection(); // Re-render with new market
          
          // Re-run backtest if results are currently showing
          if (document.getElementById('resultsSection').style.display === 'block' && selectedTeams.size > 0) {
            runBacktest();
          }
        });
      });

      // Filter change handlers
      document.getElementById('seasonFilter').addEventListener('change', () => {
        renderTeamSelection();
        
        // Re-run backtest if results are currently showing
        if (document.getElementById('resultsSection').style.display === 'block' && selectedTeams.size > 0) {
          runBacktest();
        }
      });

      // Backtest button
      document.getElementById('runBacktest').addEventListener('click', runBacktest);

      // Scroll buttons
      document.getElementById('scrollLeft').addEventListener('click', () => {
        document.getElementById('leaguesContainer').scrollBy({ left: -240, behavior: 'smooth' });
      });
      document.getElementById('scrollRight').addEventListener('click', () => {
        document.getElementById('leaguesContainer').scrollBy({ left: 240, behavior: 'smooth' });
      });

      // Update scroll buttons on scroll
      document.getElementById('leaguesContainer').addEventListener('scroll', updateScrollButtons);

      // Navigation handlers
      document.querySelector('nav button[data-nav="markets"]').addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/market.html';
      });
      
      document.querySelector('nav button[data-nav="journal"]').addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/dash.html';
      });

      loadData();
    });
  </script>

</body>
</html>
