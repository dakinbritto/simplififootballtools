<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Strategy Backtest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#0b0f14] font-sans text-zinc-200 flex flex-col opacity-0 animate-[fadeIn_0.6s_ease-in-out_forwards]" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji;">

  <!-- Loading Screen -->
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center animate-pulse">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-yellow-400 mb-3">
        <span class="relative inline-flex">
          <i data-lucide="loader-2" class="w-5 h-5 mr-1 animate-spin"></i>
          <i data-lucide="football" class="w-5 h-5 absolute -right-6 top-0 opacity-60"></i>
        </span>
        <span>Loading team data...</span>
      </div>
      <div class="text-sm text-zinc-500">Calculating team popularity metrics...</div>
    </div>
  </div>

  <!-- Error Screen -->
  <div id="error" class="flex items-center justify-center min-h-screen" style="display: none;">
    <div class="text-center bg-[#10151c] border border-red-900/40 rounded-xl px-6 py-5 shadow-sm">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-red-400 mb-2">
        <i data-lucide="triangle-alert" class="w-5 h-5"></i>
        <span>Error loading data</span>
      </div>
      <div class="text-sm text-zinc-400 mb-2">Please check your connection and try again.</div>
      <button onclick="loadData()" class="mt-3 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded-md transition-colors">
        Retry
      </button>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header class="w-full border-b border-zinc-800/80 bg-[#0f141b]/60 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 py-6 md:py-7 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-yellow-600/10 ring-1 ring-yellow-600/20">
            <i data-lucide="line-chart" class="w-5 h-5 text-yellow-500"></i>
          </span>
          <h1 class="text-2xl md:text-3xl font-semibold italic text-yellow-500 tracking-tight">Test your strategy</h1>
        </div>
        <!-- Moved Filters -->
        <div class="w-full md:w-auto grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-zinc-400 mb-1">Market</label>
            <div class="relative">
              <button id="marketDropdownBtn" class="w-full inline-flex items-center justify-between gap-x-2 text-xs font-medium text-zinc-300 hover:text-zinc-100 focus:outline-none focus:ring-2 focus:ring-yellow-500/30 rounded-md px-3 py-2 transition-all bg-[#111821] border border-zinc-800">
                <span class="inline-flex items-center gap-2">
                  <i data-lucide="target" class="w-4 h-4 text-yellow-500"></i>
                  <span id="selectedMarket" class="font-semibold tracking-tight">OVER 2.5 GOALS</span>
                </span>
                <i data-lucide="chevron-down" class="w-4 h-4"></i>
              </button>
              <div id="marketMenu" class="hidden fixed w-64 bg-[#0f141b] rounded-lg shadow-xl ring-1 ring-zinc-800 border border-zinc-800/80" style="z-index: 999999;">
                <div class="max-h-64 overflow-y-auto py-1">
                  <ul id="marketList" class="py-1 text-xs">
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="OVER 2.5 GOALS" data-value="over2.5">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2 text-yellow-500"></i>OVER 2.5 GOALS
                      </button>
                    </li>
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="UNDER 2.5 GOALS" data-value="under2.5">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-2 text-indigo-400"></i>UNDER 2.5 GOALS
                      </button>
                    </li>
                    <li>
                      <button class="w-full text-left px-3.5 py-2 hover:bg-[#141b23] flex items-center text-zinc-200" data-market="UNDER 6 GOALS" data-value="under6">
                        <i data-lucide="trending-down" class="w-4 h-4 mr-2 text-purple-400"></i>UNDER 6 GOALS
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-zinc-400 mb-1">Start From Season</label>
            <div class="relative">
              <i data-lucide="calendar" class="w-4 h-4 text-zinc-500 absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              <select id="seasonFilter" class="w-full bg-[#111821] text-white text-sm pl-7 pr-2 py-2 rounded-md border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-yellow-500/30">
                <option value="all">All Seasons</option>
              </select>
            </div>
          </div>
        </div>
        <!-- End Moved Filters -->
      </div>
    </header>

    <main class="flex-1 py-6 pb-20">
      <section class="max-w-7xl mx-auto px-4 animate-[slideInUp_1s_ease-in-out_0.2s_forwards] opacity-0">
  <!-- Getting Started - Dark Panel -->
      <div class="mb-8 bg-gradient-to-br from-[#161c23] via-[#0f1617] to-[#004e2b] p-6 rounded-2xl shadow-innerBorder border border-zinc-900/40 text-zinc-200">
        <h2 class="text-lg font-semibold mb-3">Getting Started</h2>
        <p class="text-sm text-zinc-400 leading-relaxed">
          Choose your favorite teams from the leagues below to begin backtesting the selected market strategy.
          We'll analyze historical data to show how your selected teams have performed with this market.
        </p>
      </div>
        <!-- Teams Section Header -->
        <h2 class="text-xl font-semibold mb-4 uppercase tracking-tight border-b border-zinc-800/80 pb-2 bg-gradient-to-r from-[#0e1216] via-[#0b0f14] to-[#0c2620] rounded-t-xl px-4 py-3 -mx-4 text-zinc-300">
          Select Teams for Your Strategy
        </h2>

        <!-- Horizontal Scrolling Leagues Container -->
        <div class="relative mb-6">
          <div id="leaguesContainer" class="flex gap-4 overflow-x-auto pb-4 scroll-smooth">
            <!-- Leagues will be populated here -->
          </div>

          <!-- Gradient edge indicators -->
          <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-[#0b0f14] to-transparent"></div>
          <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-[#0b0f14] to-transparent"></div>

          <!-- Scroll indicators -->
          <button id="scrollLeft" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#111821] border border-zinc-800 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-[#16202b] transition-colors shadow-sm z-10" style="display: none;">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <button id="scrollRight" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#111821] border border-zinc-800 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-[#16202b] transition-colors shadow-sm z-10">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="space-y-6" style="display: none;">

          <!-- Performance Summary -->
          <div class="bg-gradient-to-br from-[#0f141b] via-[#0d1319] to-[#0a2a1b] rounded-xl p-5 md:p-6 border border-zinc-900/50">
            <div class="flex items-center gap-3 mb-4">
              <span class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-yellow-600/10 ring-1 ring-yellow-600/20">
                <i data-lucide="trending-up" class="w-4 h-4 text-yellow-400"></i>
              </span>
              <h2 class="text-xl tracking-tight font-semibold text-white">Backtest Results</h2>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">Total Games</div>
                <div id="statGames" class="text-white font-mono text-lg">0</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">Win Rate</div>
                <div id="statWinRate" class="text-white font-mono text-lg">0%</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">ROI</div>
                <div id="statROI" class="font-mono text-lg">0%</div>
              </div>
              <div class="p-3 rounded-lg bg-[#111821] border border-zinc-800">
                <div class="text-zinc-400 text-[11px] uppercase tracking-wide mb-1">P&L</div>
                <div id="statPL" class="font-mono text-lg">Â£0</div>
              </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-zinc-800">
              <div class="text-xs text-zinc-500">
                <span id="selectedCount">0 teams</span> selected â€¢ Capital: Â£1,000 â€¢ Stakes: 5%
              </div>
              <div class="flex gap-2">
                <button id="generateBetslips" disabled class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-zinc-700 disabled:text-zinc-500 text-white text-sm rounded-md transition-colors flex items-center gap-2">
                  <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                  Generate Betslips
                </button>
              </div>
            </div>
          </div>

          <!-- Selected Teams Info -->
          <div class="bg-[#0f141b] rounded-xl p-5 border border-zinc-900/50">
            <h3 class="text-sm font-semibold text-zinc-300 mb-3">Selected Teams Performance</h3>
            <div id="selectedTeamsList" class="text-xs text-zinc-400">Select teams to see their performance data</div>
          </div>

          <!-- Chart -->
          <div class="bg-[#0f141b] rounded-xl p-5 border border-zinc-900/50">
            <h3 class="text-sm font-semibold text-zinc-300 mb-4">Capital Movement</h3>
            <div class="h-64 md:h-80">
              <canvas id="capitalChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="fixed bottom-4 left-4 right-4 md:static md:mt-8 z-20">
          <div class="bg-[#0f141b] rounded-xl p-4 border border-zinc-900/50 backdrop-blur-sm">
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-4">
              <div class="text-sm text-zinc-400">
                <span id="selectedCount2">0 teams</span> selected for backtesting
              </div>
              <div class="flex gap-2">
                <button id="runBacktest" disabled class="flex-1 sm:flex-none px-6 py-3 bg-yellow-600 hover:bg-yellow-700 disabled:bg-zinc-700 disabled:text-zinc-500 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                  <i data-lucide="play" class="w-4 h-4"></i>
                  Run Backtest
                </button>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#0b0f14] border-t border-zinc-800/80 md:hidden">
      <div class="flex items-center justify-around py-2">
        <button data-nav="markets" class="flex flex-col items-center gap-1 p-2 text-zinc-500 hover:text-yellow-500 transition-colors">
          <i data-lucide="trending-up" class="w-5 h-5"></i>
          <span class="text-xs">Markets</span>
        </button>
        <button class="flex flex-col items-center gap-1 p-2 text-yellow-500">
          <i data-lucide="line-chart" class="w-5 h-5"></i>
          <span class="text-xs">Backtest</span>
        </button>
        <button data-nav="journal" class="flex flex-col items-center gap-1 p-2 text-zinc-500 hover:text-yellow-500 transition-colors">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          <span class="text-xs">Journal</span>
        </button>
      </div>
    </nav>
  </div>

  <style>
    .team-card {
      transition: all 0.2s ease;
    }
    .team-card.selected {
      background-color: rgba(234, 179, 8, 0.1);
      border-color: rgba(234, 179, 8, 0.3);
    }
    .team-card:hover {
      background-color: rgba(63, 63, 70, 0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInUp {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
  </style>

  <script>
    // ðŸ”’ SECURE: Global variables
    let teamPopularity = {};
    let availableSeasons = [];
    let selectedTeams = new Set();
    let currentMarket = 'over2.5';
    let currentChart = null;

    // ðŸ”’ SECURE: API Configuration
    const API_BASE = 'https://api-7wyko6woyq-uc.a.run.app/calculator';

    // League flag mapping
    const leagueFlagMap = [
      { keys: ['epl', 'england', 'premier'], code: 'gb' },
      { keys: ['championship'], code: 'gb' },
      { keys: ['laliga', 'spain', 'la liga'], code: 'es' },
      { keys: ['bundesliga', 'bundes', 'german'], code: 'de' },
      { keys: ['serie', 'italy', 'italian'], code: 'it' },
      { keys: ['ligue', 'france', 'french', 'championnat'], code: 'fr' },
      { keys: ['eredivisie', 'netherlands', 'dutch'], code: 'nl' },
      { keys: ['portugal', 'primeira'], code: 'pt' },
      { keys: ['scotland', 'scottish'], code: 'gb-sct' },
      { keys: ['belgium', 'belgian'], code: 'be' },
      { keys: ['greece', 'greek'], code: 'gr' },
      { keys: ['turkey', 'turkish'], code: 'tr' }
    ];

    function getLeagueFlagCode(leagueName) {
      const name = String(leagueName || '').toLowerCase();
      for (const entry of leagueFlagMap) {
        for (const key of entry.keys) {
          if (name.includes(key)) return entry.code;
        }
      }
      return null;
    }

    function getLeagueFlagHTML(leagueName) {
      const code = getLeagueFlagCode(leagueName);
      if (code) {
        const src = `https://flagcdn.com/${code}.svg`;
        return `<div class="h-4 w-6 rounded-[3px] overflow-hidden ring-1 ring-zinc-700/60 bg-zinc-900"><img src="${src}" alt="${leagueName} flag" class="h-full w-full object-cover" loading="lazy"></div>`;
      }
      return `<span class="inline-flex h-6 w-6 items-center justify-center rounded bg-yellow-600/10 ring-1 ring-yellow-600/20"><i data-lucide="shield" class="h-3.5 w-3.5 text-yellow-400"></i></span>`;
    }

    // ðŸ”’ SECURE: Generate betslips via API
    async function generateBetslips() {
      if (selectedTeams.size === 0) {
        alert('Please select at least one team first.');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/generate-betslips`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            selectedTeams: Array.from(selectedTeams),
            market: currentMarket
          })
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to fixtures page with the generated URL
          window.location.href = data.redirectUrl;
        } else {
          alert('Error generating betslips: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error generating betslips:', error);
        alert('Error generating betslips. Please try again.');
      }
    }

    // ðŸ”’ SECURE: Load team popularity data from API
    async function loadData() {
      try {
        const response = await fetch(`${API_BASE}/team-popularity`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            startingSeason: 'all'
          })
        });

        const data = await response.json();

        if (data.success) {
          teamPopularity = data.teamPopularity;
          availableSeasons = data.availableSeasons;
          
          populateSeasonFilters();
          renderTeamSelection();
          hideLoading();
        } else {
          throw new Error(data.error || 'Failed to load team data');
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showError();
      }
    }

    // Populate season filters
    function populateSeasonFilters() {
      const seasonFilter = document.getElementById('seasonFilter');
      // Clear existing options except "All Seasons"
      seasonFilter.innerHTML = '<option value="all">All Seasons</option>';
      
      availableSeasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = season.toUpperCase();
        seasonFilter.appendChild(option);
      });
    }

    // Get filtered teams based on current filters
    function getFilteredTeams() {
      const seasonFilter = document.getElementById('seasonFilter').value;
      
      if (seasonFilter === 'all') {
        return teamPopularity;
      }

      // For season filtering, we'll need to call the API again
      // For now, return all data (server handles filtering)
      return teamPopularity;
    }

    // Render team selection interface
    function renderTeamSelection() {
      const container = document.getElementById('leaguesContainer');
      const filteredPopularity = getFilteredTeams();
      container.innerHTML = '';

      let getPercentage, sortOrder;

      if (currentMarket === 'over2.5') {
        getPercentage = (stats) => stats.over25Percentage;
        sortOrder = (a, b) => b[1].over25Percentage - a[1].over25Percentage;
      } else if (currentMarket === 'under2.5') {
        getPercentage = (stats) => stats.under25Percentage;
        sortOrder = (a, b) => b[1].under25Percentage - a[1].under25Percentage;
      } else if (currentMarket === 'under6') {
        getPercentage = (stats) => stats.under6Percentage;
        sortOrder = (a, b) => b[1].under6Percentage - a[1].under6Percentage;
      }

      Object.keys(filteredPopularity).forEach(league => {
        const teams = filteredPopularity[league];
        const sortedTeams = Object.entries(teams).sort(sortOrder);
        if (sortedTeams.length === 0) return;

        const leagueCard = document.createElement('div');
        leagueCard.className = 'bg-[#0f141b] p-4 rounded-lg shadow-sm border border-zinc-900/60 min-w-[280px] flex-shrink-0';

        leagueCard.innerHTML = `
          <div class="flex items-center gap-2 mb-3">
            ${getLeagueFlagHTML(league)}
            <h3 class="text-sm font-semibold text-zinc-200">${league}</h3>
            <span class="text-[11px] text-zinc-400 bg-[#111821] border border-zinc-800 px-2 py-0.5 rounded">${sortedTeams.length}</span>
          </div>
          <div class="space-y-2 max-h-64 overflow-y-auto pr-1">
            ${sortedTeams.map(([team, stats]) => {
              const isSelected = selectedTeams.has(`${league}:${team}`);
              return `
                <label class="team-card flex items-center justify-between p-2 border border-zinc-800 rounded cursor-pointer ${isSelected ? 'selected' : ''}" data-team="${team}" data-league="${league}">
                  <div class="flex items-center gap-2">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} class="rounded border-zinc-700 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0 w-3.5 h-3.5 bg-[#0b1016]">
                    <div>
                      <div class="text-xs font-medium text-white tracking-tight">${team}</div>
                      <div class="text-[11px] text-zinc-500">${stats.validMatches}m</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs font-mono text-yellow-400">${getPercentage(stats).toFixed(1)}%</div>
                  </div>
                </label>
              `;
            }).join('')}
          </div>
        `;

        container.appendChild(leagueCard);
      });

      // Update scroll button visibility
      updateScrollButtons();

      // Add event listeners for team selection
      container.addEventListener('change', handleTeamSelection);

      // Initialize lucide icons
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }
    }

    // Update scroll button visibility
    function updateScrollButtons() {
      const container = document.getElementById('leaguesContainer');
      const scrollLeft = document.getElementById('scrollLeft');
      const scrollRight = document.getElementById('scrollRight');

      const canScrollLeft = container.scrollLeft > 0;
      const canScrollRight = container.scrollLeft < (container.scrollWidth - container.clientWidth) - 1;

      scrollLeft.style.display = canScrollLeft ? 'flex' : 'none';
      scrollRight.style.display = canScrollRight ? 'flex' : 'none';
    }

    // Handle team selection
    function handleTeamSelection(event) {
      if (event.target.type === 'checkbox') {
        const label = event.target.closest('.team-card');
        const team = label.dataset.team;
        const league = label.dataset.league;
        const teamKey = `${league}:${team}`;

        if (event.target.checked) {
          selectedTeams.add(teamKey);
          label.classList.add('selected');
        } else {
          selectedTeams.delete(teamKey);
          label.classList.remove('selected');
        }
        updateSelectedCount();
      }
    }

    // Update selected count and enable/disable buttons
    function updateSelectedCount() {
      const count = selectedTeams.size;
      document.getElementById('selectedCount').textContent = `${count} team${count !== 1 ? 's' : ''}`;
      document.getElementById('selectedCount2').textContent = `${count} team${count !== 1 ? 's' : ''}`;
      const runBtn = document.getElementById('runBacktest');
      const genBtn = document.getElementById('generateBetslips');
      if (runBtn) runBtn.disabled = count === 0;
      if (genBtn) genBtn.disabled = count === 0;
    }

    // ðŸ”’ SECURE: Run backtest via API
    async function runBacktest() {
      if (selectedTeams.size === 0) return;

      const runBtn = document.getElementById('runBacktest');
      const originalText = runBtn.innerHTML;
      
      try {
        // Show loading state
        runBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-2"></i>Running...';
        runBtn.disabled = true;

        const seasonFilter = document.getElementById('seasonFilter').value;

        const response = await fetch(`${API_BASE}/backtest`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            selectedTeams: Array.from(selectedTeams),
            market: currentMarket,
            startingSeason: seasonFilter,
            startingCapital: 1000,
            stakePercentage: 5
          })
        });

        const data = await response.json();

        if (data.success) {
          updateResults(data.stats);
          updateChart(data.chartData, 1000);
          showSelectedTeamsInfo(data.selectedTeamsInfo);
          document.getElementById('resultsSection').style.display = 'block';
        } else {
          throw new Error(data.error || 'Backtesting failed');
        }
      } catch (error) {
        console.error('Error running backtest:', error);
        alert('Error running backtest: ' + error.message);
      } finally {
        // Restore button state
        runBtn.innerHTML = originalText;
        runBtn.disabled = selectedTeams.size === 0;
        if (window.lucide) {
          window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
        }
      }
    }

    // Update results display
    function updateResults(stats) {
      document.getElementById('statGames').textContent = stats.totalGames;
      document.getElementById('statWinRate').textContent = `${stats.winRate.toFixed(1)}%`;
      
      const roi = stats.roi;
      const roiEl = document.getElementById('statROI');
      roiEl.textContent = `${roi >= 0 ? '+' : ''}${roi.toFixed(1)}%`;
      roiEl.className = `font-mono text-lg ${roi >= 0 ? 'text-green-400' : 'text-red-400'}`;

      const totalReturn = stats.totalReturn;
      const plEl = document.getElementById('statPL');
      plEl.textContent = `${totalReturn >= 0 ? '+' : ''}Â£${Math.abs(totalReturn).toFixed(0)}`;
      plEl.className = `font-mono text-lg ${totalReturn >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    // Update chart
    function updateChart(chartData, startingCapital) {
      const ctx = document.getElementById('capitalChart');
      
      if (currentChart) {
        currentChart.destroy();
      }

      const isProfit = chartData.length > 0 && chartData[chartData.length - 1].y >= startingCapital;
      const lineColor = isProfit ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
      
      currentChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Capital Movement',
              data: chartData,
              borderColor: lineColor,
              backgroundColor: isProfit ? 
                'rgba(34, 197, 94, 0.1)' : 
                'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 4,
              tension: 0.1
            },
            {
              label: 'Starting Capital',
              data: [
                {x: 0, y: startingCapital},
                {x: chartData.length > 0 ? chartData[chartData.length - 1].x : 1, y: startingCapital}
              ],
              borderColor: 'rgba(255, 255, 255, 0.25)',
              borderDash: [5, 5],
              borderWidth: 1,
              pointRadius: 0,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: lineColor,
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: (context) => `Game ${context[0].dataIndex + 1}`,
                label: (context) => `Capital: Â£${Math.round(context.parsed.y)}`
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              display: true,
              grid: { color: 'rgba(255, 255, 255, 0.08)', drawBorder: false },
              ticks: { color: '#6b7280', maxTicksLimit: 8 },
              title: { display: true, text: 'Game Number', color: '#6b7280' }
            },
            y: {
              display: true,
              grid: { color: 'rgba(255, 255, 255, 0.08)', drawBorder: false },
              ticks: { color: '#6b7280', callback: (v) => `Â£${v}` },
              title: { display: true, text: 'Capital (Â£)', color: '#6b7280' }
            }
          }
        }
      });
    }

    // Show selected teams info
    function showSelectedTeamsInfo(selectedTeamsInfo) {
      const teamsList = selectedTeamsInfo.map(info => {
        if (info.error) {
          return `${info.team} (${info.league}) - ${info.error}`;
        }
        return `${info.team} (${info.league}) - ${info.percentage}% (${info.validMatches}m)`;
      }).join(', ');

      document.getElementById('selectedTeamsList').textContent = teamsList;
    }

    // Visibility helpers
    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }

      // Market dropdown functionality
      const btn = document.getElementById('marketDropdownBtn');
      const menu = document.getElementById('marketMenu');
      const selectedMarketEl = document.getElementById('selectedMarket');

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (menu.classList.contains('hidden')) {
          const btnRect = btn.getBoundingClientRect();
          menu.style.top = `${btnRect.bottom + 2}px`;
          menu.style.left = `${btnRect.left}px`;
          menu.classList.remove('hidden');
        } else {
          menu.classList.add('hidden');
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        menu.classList.add('hidden');
      });

      // Market selection
      const marketButtons = menu.querySelectorAll('button[data-market]');
      marketButtons.forEach(mbtn => {
        mbtn.addEventListener('click', () => {
          currentMarket = mbtn.dataset.value;
          selectedMarketEl.textContent = mbtn.dataset.market;
          menu.classList.add('hidden');
          renderTeamSelection(); // Re-render with new market
        });
      });

      // Filter change handlers
      document.getElementById('seasonFilter').addEventListener('change', () => {
        renderTeamSelection();
      });

      // Button handlers
      document.getElementById('runBacktest').addEventListener('click', runBacktest);
      document.getElementById('generateBetslips').addEventListener('click', generateBetslips);

      // Scroll buttons
      document.getElementById('scrollLeft').addEventListener('click', () => {
        document.getElementById('leaguesContainer').scrollBy({ left: -240, behavior: 'smooth' });
      });
      document.getElementById('scrollRight').addEventListener('click', () => {
        document.getElementById('leaguesContainer').scrollBy({ left: 240, behavior: 'smooth' });
      });

      // Update scroll buttons on scroll
      document.getElementById('leaguesContainer').addEventListener('scroll', updateScrollButtons);

      // Navigation handlers
      document.querySelector('nav button[data-nav="markets"]').addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/zmarket.html';
      });
      
      document.querySelector('nav button[data-nav="journal"]').addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/dash.html';
      });

      loadData();
    });
  </script>

</body>
</html>
