<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Fixtures - Simplifi Football</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#0b0f14] font-sans text-zinc-200 flex flex-col opacity-0 animate-[fadeIn_0.6s_ease-in-out_forwards]" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji;">

  <!-- üîí Authentication Required Screen -->
  <div id="authRequired" class="flex items-center justify-center min-h-screen" style="display: none;">
    <div class="text-center bg-[#10151c] border border-yellow-900/40 rounded-xl px-8 py-6 shadow-lg max-w-md mx-4">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-yellow-400 mb-4">
        <i data-lucide="lock" class="w-6 h-6"></i>
        <span>Authentication Required</span>
      </div>
      <div class="text-sm text-zinc-300 mb-4">Please sign in to access live fixtures</div>
      <div class="space-y-2">
        <button onclick="window.location.href='login.html'" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-medium py-2 px-4 rounded-lg transition-colors">
          Sign In
        </button>
        <button onclick="window.location.href='register.html'" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-200 font-medium py-2 px-4 rounded-lg transition-colors">
          Create Account
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center animate-pulse">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-yellow-400 mb-3">
        <span class="relative inline-flex">
          <i data-lucide="loader-2" class="w-5 h-5 mr-1 animate-spin"></i>
          <i data-lucide="calendar" class="w-5 h-5 absolute -right-6 top-0 opacity-60"></i>
        </span>
        <span>Loading fixtures...</span>
      </div>
      <div class="text-sm text-zinc-500">Verifying authentication...</div>
    </div>
  </div>

  <!-- Error Screen -->
  <div id="error" class="flex items-center justify-center min-h-screen" style="display: none;">
    <div class="text-center bg-[#10151c] border border-red-900/40 rounded-xl px-6 py-5 shadow-sm">
      <div class="inline-flex items-center gap-2 text-xl tracking-tight text-red-400 mb-2">
        <i data-lucide="triangle-alert" class="w-5 h-5"></i>
        <span>Error loading fixtures</span>
      </div>
      <div class="text-sm text-zinc-400 mb-2">Authentication or connection issue:</div>
      <ul class="text-xs text-zinc-500 text-left inline-block space-y-1">
        <li>‚Ä¢ Please sign in again</li>
        <li>‚Ä¢ Check your internet connection</li>
        <li>‚Ä¢ API server may be down</li>
      </ul>
      <div class="mt-4 space-y-2">
        <button onclick="checkAuthentication()" class="w-full text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded transition-colors">
          Retry Authentication
        </button>
        <button onclick="logout()" class="w-full text-xs bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1 rounded transition-colors">
          Sign Out & Retry
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header class="w-full border-b border-zinc-800/80 bg-[#0f141b]/60 backdrop-blur sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 py-6 md:py-7">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-yellow-600/10 ring-1 ring-yellow-600/20">
              <i data-lucide="calendar" class="w-5 h-5 text-yellow-500"></i>
            </span>
            <h1 class="text-2xl md:text-3xl font-semibold italic text-yellow-500 tracking-tight">Live Fixtures</h1>
          </div>
          
          <!-- User controls -->
          <div class="flex items-center gap-3">
            <!-- Live indicator -->
            <div class="flex items-center gap-2 bg-[#111821] border border-zinc-800 rounded-md px-3 py-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm font-medium text-green-400">LIVE</span>
              <span id="lastUpdated" class="text-xs text-zinc-500 ml-2">Updated now</span>
            </div>
            
            <!-- üîí User menu -->
            <div class="relative">
              <button id="userMenuBtn" class="flex items-center gap-2 bg-[#111821] border border-zinc-800 rounded-md px-3 py-2 hover:border-zinc-700 transition-colors">
                <i data-lucide="user" class="w-4 h-4 text-zinc-400"></i>
                <span id="userEmail" class="text-sm text-zinc-300">User</span>
                <i data-lucide="chevron-down" class="w-4 h-4 text-zinc-400"></i>
              </button>
              <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-[#0f141b] rounded-lg shadow-xl ring-1 ring-zinc-800 z-50 border border-zinc-800/80">
                <div class="py-1">
                  <div class="px-4 py-2 text-xs text-zinc-500 border-b border-zinc-800">
                    <div>Signed in as:</div>
                    <div id="userEmailFull" class="text-zinc-300 font-medium mt-1"></div>
                  </div>
                  <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[#111821] transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div id="filterSection" class="mb-6 bg-[#0f141b] border border-zinc-900/60 rounded-lg overflow-hidden transition-all duration-300">
          <!-- Filter Header -->
          <div class="p-4 border-b border-zinc-800 bg-[#111821]">
            <button id="toggleFilter" class="flex items-center justify-between w-full text-left">
              <div class="flex items-center gap-2">
                <i data-lucide="filter" class="w-5 h-5 text-yellow-500"></i>
                <h3 class="text-sm font-semibold text-white">Team Filters</h3>
                <span id="filterBadge" class="text-xs bg-yellow-600/20 text-yellow-400 px-2 py-0.5 rounded hidden">
                  Active
                </span>
              </div>
              <i data-lucide="chevron-down" id="filterChevron" class="w-4 h-4 text-zinc-400 transition-transform duration-200"></i>
            </button>
          </div>

          <!-- Filter Content (Collapsible) -->
          <div id="filterContent" class="p-4 transition-all duration-300 ease-in-out max-h-0 overflow-hidden opacity-0">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
              <!-- Team Filter -->
              <div class="flex-1">
                <label class="block text-xs font-medium text-zinc-400 mb-2">Filter by Teams</label>
                <div class="relative">
                  <button id="teamFilterBtn" class="w-full inline-flex items-center justify-between gap-x-2 text-sm font-medium text-zinc-300 hover:text-zinc-100 focus:outline-none focus:ring-2 focus:ring-yellow-500/30 rounded-md px-3 py-2 transition-all bg-[#111821] border border-zinc-800">
                    <span class="inline-flex items-center gap-2">
                      <i data-lucide="users" class="w-4 h-4 text-yellow-500"></i>
                      <span id="selectedTeamsText">All Teams</span>
                    </span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                  </button>
                  <div id="teamFilterMenu" class="hidden absolute left-0 mt-2 w-full bg-[#0f141b] rounded-lg shadow-xl ring-1 ring-zinc-800 z-10 border border-zinc-800/80 max-h-64 overflow-y-auto">
                    <div class="p-2">
                      <input id="teamSearch" type="text" placeholder="Search teams..." class="w-full bg-[#111821] text-white text-sm px-3 py-2 rounded-md border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-yellow-500/30 mb-2">
                    </div>
                    <div id="teamOptions" class="py-1">
                      <!-- Team options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selected Teams Display -->
              <div class="flex-1">
                <label class="block text-xs font-medium text-zinc-400 mb-2">Selected Teams (<span id="selectedCount">0</span>)</label>
                <div id="selectedTeamsDisplay" class="min-h-[38px] bg-[#111821] border border-zinc-800 rounded-md px-3 py-2 text-sm text-zinc-300 flex flex-wrap gap-1">
                  <span class="text-zinc-500">No teams selected</span>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex gap-2">
                <button id="clearAllTeams" class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white transition-colors border border-zinc-800 rounded-md hover:border-zinc-700">
                  Clear All
                </button>
                <button id="applyFilter" class="px-4 py-2 text-sm font-medium text-zinc-900 bg-yellow-600 hover:bg-yellow-500 transition-colors rounded-md">
                  Apply Filter
                </button>
              </div>
            </div>

            <!-- Filter Status -->
            <div id="filterStatus" class="mt-3 pt-3 border-t border-zinc-800" style="display: none;">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm">
                  <i data-lucide="filter" class="w-4 h-4 text-purple-400"></i>
                  <span class="text-purple-400 font-medium">Filtered View Active</span>
                  <span class="text-zinc-500">|</span>
                  <span class="text-zinc-400">Market: <span id="currentMarket" class="text-purple-300"></span></span>
                </div>
                <button id="clearFilter" class="text-zinc-400 hover:text-white transition-colors text-sm">
                  <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>Show All
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 py-6 pb-20">
      <div class="max-w-7xl mx-auto px-4">
        
        <!-- Stats Summary -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-[#0f141b] border border-zinc-900/60 p-4 rounded-lg">
            <div class="text-zinc-400 text-xs uppercase tracking-wide mb-1">Total Fixtures</div>
            <div id="totalFixtures" class="text-white font-mono text-xl">0</div>
          </div>
          <div class="bg-[#0f141b] border border-zinc-900/60 p-4 rounded-lg">
            <div class="text-zinc-400 text-xs uppercase tracking-wide mb-1">Weekly Betslips</div>
            <div id="weeklyBetslips" class="text-purple-400 font-mono text-xl">0</div>
          </div>
          <div class="bg-[#0f141b] border border-zinc-900/60 p-4 rounded-lg">
            <div class="text-zinc-400 text-xs uppercase tracking-wide mb-1">Completed</div>
            <div id="completedFixtures" class="text-yellow-400 font-mono text-xl">0</div>
          </div>
          <div class="bg-[#0f141b] border border-zinc-900/60 p-4 rounded-lg">
            <div class="text-zinc-400 text-xs uppercase tracking-wide mb-1">Teams</div>
            <div id="uniqueTeams" class="text-blue-400 font-mono text-xl">0</div>
          </div>
        </div>

        <!-- Betslips Container (for filtered view) -->
        <div id="betslipsContainer" class="space-y-6" style="display: none;">
          <!-- Weekly betslips will be populated here -->
        </div>

        <!-- Fixtures Container (for unfiltered view) -->
        <div id="fixturesContainer" class="space-y-6">
          <!-- Fixtures will be populated here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12" style="display: none;">
          <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-zinc-800/40 mb-4">
            <i data-lucide="calendar-x" class="w-8 h-8 text-zinc-500"></i>
          </div>
          <h3 class="text-lg font-semibold text-zinc-300 mb-2">No fixtures found</h3>
          <p class="text-sm text-zinc-500">There are no fixtures for the selected teams.</p>
        </div>

      </div>
    </main>

    <!-- Betslip Cart (floating button) -->
    <div id="betslipCart" class="fixed bottom-20 right-4 z-50">
      <button id="betslipBtn" class="relative bg-yellow-600 hover:bg-yellow-500 text-zinc-900 rounded-full p-4 shadow-lg transition-all duration-300 transform hover:scale-105">
        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
        <span id="betslipCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center opacity-0 scale-0 transition-all duration-300">0</span>
      </button>
    </div>

    <!-- Betslip Sidebar -->
    <div id="betslipSidebar" class="fixed top-0 right-0 h-full w-96 bg-[#0b0f14] border-l border-zinc-800 transform translate-x-full transition-transform duration-300 z-50 overflow-hidden">
      <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="p-4 border-b border-zinc-800 flex-shrink-0">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <i data-lucide="shopping-cart" class="w-5 h-5 text-yellow-500"></i>
              <h3 class="text-lg font-semibold text-white">Betslip</h3>
            </div>
            <button id="closeBetslip" class="text-zinc-400 hover:text-white transition-colors">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          
          <!-- Capital Input -->
          <div class="space-y-2">
            <label class="block text-xs font-medium text-zinc-400">Total Capital (¬£)</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-zinc-500 text-sm">¬£</span>
              <input 
                type="number" 
                id="totalCapital" 
                placeholder="0.00" 
                min="0" 
                step="0.01"
                class="w-full bg-[#111821] text-white text-sm pl-8 pr-3 py-2 rounded-md border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-yellow-500/30"
              >
            </div>
            <div id="stakeInfo" class="text-xs text-zinc-500 hidden">
              <div id="stakeRules"></div>
            </div>
          </div>
        </div>

        <!-- Content (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-4">
          <div id="betslipSelections" class="space-y-3">
            <!-- Selections will be populated here -->
          </div>
          
          <!-- Empty state -->
          <div id="betslipEmpty" class="text-center py-8">
            <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-zinc-800/40 mb-3">
              <i data-lucide="shopping-cart" class="w-6 h-6 text-zinc-500"></i>
            </div>
            <p class="text-zinc-400 text-sm">No selections added yet</p>
            <p class="text-zinc-500 text-xs mt-1">Add fixtures to build your betslip</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-zinc-800 flex-shrink-0">
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="flex justify-between">
                <span class="text-zinc-400">Total Betslips:</span>
                <span id="totalBetslips" class="text-white font-medium">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">Completed Stakes:</span>
                <span id="totalStaked" class="text-white font-mono">¬£0.00</span>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="flex justify-between">
                <span class="text-zinc-400">Current Profit:</span>
                <span id="currentProfit" class="text-yellow-400 font-mono">¬£0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-zinc-400">New Capital:</span>
                <span id="newCapital" class="text-green-400 font-mono">¬£0.00</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button id="updateScores" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-md transition-colors">
                Update Scores
              </button>
              <button id="proceedToJournal" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-zinc-900 font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Proceed to Journal
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Betslip Overlay -->
    <div id="betslipOverlay" class="fixed inset-0 bg-black/50 opacity-0 invisible transition-all duration-300 z-40"></div>

    <!-- Market Selection Modal -->
    <div id="marketModal" class="fixed inset-0 bg-black/50 opacity-0 invisible transition-all duration-300 z-50 flex items-center justify-center">
      <div class="bg-[#0b0f14] border border-zinc-800 rounded-xl p-6 max-w-md mx-4 transform scale-95 transition-transform duration-300">
        <div class="text-center mb-4">
          <h3 class="text-lg font-semibold text-white mb-2">Select Market</h3>
          <div id="selectedFixtureInfo" class="text-sm text-zinc-400">
            <!-- Fixture info will be populated here -->
          </div>
        </div>
        
        <div class="space-y-3 mb-6">
          <button onclick="addSelectedFixtureToJournal('over2.5')" class="w-full flex items-center justify-between p-4 bg-yellow-600/10 hover:bg-yellow-600/20 border border-yellow-600/20 rounded-lg text-yellow-400 transition-all">
            <div class="flex items-center gap-3">
              <i data-lucide="trending-up" class="w-5 h-5"></i>
              <div class="text-left">
                <div class="font-medium">Over 2.5 Goals</div>
                <div class="text-xs text-yellow-500">Single selection - 1.57 odds</div>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
          
          <button onclick="addSelectedFixtureToJournal('under2.5')" class="w-full flex items-center justify-between p-4 bg-indigo-600/10 hover:bg-indigo-600/20 border border-indigo-600/20 rounded-lg text-indigo-400 transition-all">
            <div class="flex items-center gap-3">
              <i data-lucide="trending-down" class="w-5 h-5"></i>
              <div class="text-left">
                <div class="font-medium">Under 2.5 Goals</div>
                <div class="text-xs text-indigo-500">Single selection - 1.8 odds</div>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
          
          <button onclick="addSelectedFixtureToJournal('under6')" class="w-full flex items-center justify-between p-4 bg-purple-600/10 hover:bg-purple-600/20 border border-purple-600/20 rounded-lg text-purple-400 transition-all">
            <div class="flex items-center gap-3">
              <i data-lucide="trending-down" class="w-5 h-5"></i>
              <div class="text-left">
                <div class="font-medium">Under 6 Goals</div>
                <div class="text-xs text-purple-500">Groups of 3 - 1.12 odds per group</div>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>
        
        <div class="flex gap-3">
          <button onclick="closeMarketModal()" class="flex-1 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg transition-colors">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <footer class="bg-gradient-to-br from-[#0f141b] via-[#0d1319] to-[#0a2a1b] border-t border-zinc-900/60 py-4">
      <div class="max-w-7xl mx-auto px-4 text-center text-xs text-zinc-500">
        <p><span id="fixtureCount">0</span> fixtures loaded ‚Ä¢ <a href="backtesting.html" class="text-yellow-400 hover:text-yellow-300">‚Üê Back to Backtesting</a></p>
      </div>
    </footer>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#0f141b] border-t border-zinc-800 z-50">
    <div class="max-w-md mx-auto">
      <div class="flex">
        <!-- Markets -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-zinc-400 hover:text-zinc-200 transition-colors" data-nav="markets">
          <i data-lucide="trending-up" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Markets</span>
        </button>
        
        <!-- Fixtures (Active) -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-yellow-500 transition-colors">
          <i data-lucide="calendar" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Fixtures</span>
          <div class="w-1 h-1 bg-yellow-500 rounded-full mt-1"></div>
        </button>
        
        <!-- Backtesting -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-zinc-400 hover:text-zinc-200 transition-colors" data-nav="backtesting">
          <i data-lucide="line-chart" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Backtesting</span>
        </button>
        
        <!-- Journal -->
        <button class="flex-1 flex flex-col items-center justify-center py-3 px-2 text-zinc-400 hover:text-zinc-200 transition-colors" data-nav="journal">
          <i data-lucide="book-open" class="w-5 h-5 mb-1"></i>
          <span class="text-xs font-medium">Journal</span>
        </button>
      </div>
    </div>
  </nav>

  <style>
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes slideInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .fixture-card {
      @apply transition-all duration-200;
    }
    .fixture-card:hover {
      @apply transform -translate-y-0.5;
    }

    .status-live {
      @apply bg-green-500/10 text-green-400 border-green-500/20;
    }
    .status-finished {
      @apply bg-zinc-600/10 text-zinc-400 border-zinc-600/20;
    }
    .status-upcoming {
      @apply bg-blue-500/10 text-blue-400 border-blue-500/20;
    }
    .status-postponed {
      @apply bg-red-500/10 text-red-400 border-red-500/20;
    }

    .betslip-card {
      @apply bg-gradient-to-br from-[#0f141b] via-[#1a1d2e] to-[#0a0f1b] border border-purple-900/40;
    }

    .league-header {
      @apply sticky top-[140px] z-30 bg-[#0b0f14]/90 backdrop-blur border-b border-zinc-800/60;
    }

    .betslip-selection {
      @apply bg-[#111821] border border-zinc-800 rounded-lg p-3 transition-all duration-200;
    }
    .betslip-selection:hover {
      @apply border-zinc-700;
    }

    .selection-invalid {
      @apply border-red-800 bg-red-900/10;
    }

    .betslip-group {
      @apply border-2 border-dashed border-purple-700/40 rounded-lg p-3 mb-4;
    }

    .incomplete-betslip {
      @apply border-orange-700/40;
    }
  </style>

  <script>
    // üîí AUTHENTICATION SYSTEM
    let authToken = null;
    let currentUser = null;

    // üîí Get stored authentication token
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    // üîí Store authentication token
    function setAuthToken(token) {
      authToken = token;
      if (token) {
        localStorage.setItem('authToken', token);
      } else {
        localStorage.removeItem('authToken');
      }
    }

    // üîí Check if user is authenticated
    async function checkAuthentication() {
      const token = getAuthToken();
      
      if (!token) {
        showAuthRequired();
        return false;
      }

      try {
        // Verify token with auth API
        const response = await fetch('https://api-7wyko6woyq-uc.a.run.app/auth/profile', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.user) {
            currentUser = data.user;
            authToken = token;
            updateUserUI();
            return true;
          }
        }
        
        // Token invalid, clear it
        setAuthToken(null);
        showAuthRequired();
        return false;
        
      } catch (error) {
        console.error('Authentication check failed:', error);
        showAuthRequired();
        return false;
      }
    }

    // üîí Update user interface with user info
    function updateUserUI() {
      if (currentUser) {
        const userEmail = document.getElementById('userEmail');
        const userEmailFull = document.getElementById('userEmailFull');
        
        if (userEmail) {
          const displayEmail = currentUser.email.length > 12 ? 
            currentUser.email.substring(0, 12) + '...' : 
            currentUser.email;
          userEmail.textContent = displayEmail;
        }
        
        if (userEmailFull) {
          userEmailFull.textContent = currentUser.email;
        }
      }
    }

    // üîí Show authentication required screen
    function showAuthRequired() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('authRequired').style.display = 'flex';
    }

    // üîí Logout user
    function logout() {
      setAuthToken(null);
      currentUser = null;
      
      // Clear any cached data
      localStorage.removeItem('betslipSelections');
      localStorage.removeItem('currentMarketType');
      localStorage.removeItem('filterSectionExpanded');
      
      // Redirect to login or show auth required
      window.location.href = 'login.html';
    }

    // üîí Make authenticated API request
    async function makeAuthenticatedRequest(url, options = {}) {
      const token = getAuthToken();
      
      if (!token) {
        throw new Error('No authentication token available');
      }
      
      const authOptions = {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...(options.headers || {})
        }
      };
      
      const response = await fetch(url, authOptions);
      
      // Handle authentication errors
      if (response.status === 401) {
        setAuthToken(null);
        showAuthRequired();
        throw new Error('Authentication required');
      }
      
      return response;
    }

    // Global variables (same as before)
    let fixturesData = [];
    let filteredFixtures = [];
    let selectedTeams = [];
    let selectedMarket = '';
    let isFiltered = false;
    let allTeams = new Set();
    let userSelectedTeams = new Set();

    // Betslip management (same as before)
    let betslipSelections = JSON.parse(localStorage.getItem('betslipSelections') || '[]');
    let currentMarketType = localStorage.getItem('currentMarketType') || null;
    let selectedFixtureForModal = null;

    // Market configuration (same as before)
    const marketConfig = {
      'over2.5': { maxSelections: 1, name: 'Over 2.5 Goals', odds: 1.57 },
      'under2.5': { maxSelections: 1, name: 'Under 2.5 Goals', odds: 1.8 },
      'under6': { maxSelections: Infinity, name: 'Under 6 Goals', odds: 1.12, groupSize: 3 }
    };

    // League flag mapping (same as before)
    const leagueFlagMap = [
      { code: 'gb-eng', keys: ['epl', 'english premier league', 'english premiership'] },
      { code: 'gb', keys: ['england', 'premier league', 'championship', 'league one', 'league two'] },
      { code: 'gb-sct', keys: ['scotland', 'scottish'] },
      { code: 'es', keys: ['spain', 'la liga', 'laliga', 'segunda'] },
      { code: 'it', keys: ['italy', 'serie a', 'serie b'] },
      { code: 'de', keys: ['germany', 'bundesliga', 'zweite bundesliga'] },
      { code: 'fr', keys: ['france', 'ligue 1', 'ligue 2'] },
      { code: 'nl', keys: ['netherlands', 'eredivisie'] },
      { code: 'pt', keys: ['portugal', 'primeira'] },
      { code: 'tr', keys: ['turkey', 's√ºper lig', 'super lig'] },
      { code: 'be', keys: ['belgium', 'pro league'] }
    ];

    function getLeagueFlagCode(leagueName) {
      const name = String(leagueName || '').toLowerCase();
      for (const entry of leagueFlagMap) {
        for (const key of entry.keys) {
          if (name.includes(key)) return entry.code;
        }
      }
      return null;
    }

    function getLeagueFlagHTML(leagueName) {
      const code = getLeagueFlagCode(leagueName);
      if (code) {
        return `<img src="https://flagcdn.com/${code}.svg" alt="${leagueName}" class="h-4 w-6 rounded-sm object-cover" loading="lazy">`;
      }
      return `<div class="h-4 w-6 bg-zinc-700 rounded-sm flex items-center justify-center"><i data-lucide="shield" class="h-3 w-3 text-zinc-400"></i></div>`;
    }

    // Improved team name matching (same as before)
    function normalizeTeamName(name) {
      return String(name || '').toLowerCase().trim()
        .replace(/\s+/g, ' ')
        .replace(/fc$|f\.c\.$/, '')
        .replace(/united$/, 'utd')
        .replace(/city$/, '')
        .trim();
    }

    function teamMatches(team1, team2) {
      const norm1 = normalizeTeamName(team1);
      const norm2 = normalizeTeamName(team2);
      
      if (norm1 === norm2) return true;
      if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
      
      const similarity = calculateSimilarity(norm1, norm2);
      return similarity > 0.8;
    }

    function calculateSimilarity(str1, str2) {
      const len1 = str1.length;
      const len2 = str2.length;
      const matrix = Array(len2 + 1).fill().map(() => Array(len1 + 1).fill(0));

      for (let i = 0; i <= len1; i++) matrix[0][i] = i;
      for (let j = 0; j <= len2; j++) matrix[j][0] = j;

      for (let j = 1; j <= len2; j++) {
        for (let i = 1; i <= len1; i++) {
          if (str1[i - 1] === str2[j - 1]) {
            matrix[j][i] = matrix[j - 1][i - 1];
          } else {
            matrix[j][i] = Math.min(
              matrix[j - 1][i] + 1,
              matrix[j][i - 1] + 1,
              matrix[j - 1][i - 1] + 1
            );
          }
        }
      }

      const maxLen = Math.max(len1, len2);
      return maxLen === 0 ? 1 : (maxLen - matrix[len2][len1]) / maxLen;
    }

    // All calculation functions (same as before - calculateStakeAndReturns, updateStakeDisplay, getBetslipCount, etc.)
    function calculateStakeAndReturns() {
      const capitalInput = document.getElementById('totalCapital');
      const capital = capitalInput ? parseFloat(capitalInput.value) || 0 : 0;
      if (capital <= 0) return { stakes: [], totalStaked: 0, totalPotentialReturns: 0, currentProfit: 0, newCapital: capital };

      const stakes = [];
      let totalStaked = 0;
      let totalPotentialReturns = 0;
      let currentProfit = 0;

      if (currentMarketType === 'under6') {
        const stakePerBetslip = capital * 0.1;
        const config = marketConfig['under6'];
        const groupSize = config.groupSize;
        
        for (let i = 0; i < betslipSelections.length; i += groupSize) {
          const group = betslipSelections.slice(i, i + groupSize);
          if (group.length === groupSize) {
            const groupNumber = Math.floor(i / groupSize) + 1;
            const groupResult = group[0]?.groupResult || 'pending';
            const potentialReturn = stakePerBetslip * config.odds;
            
            let actualReturn = 0;
            if (groupResult === 'win') {
              actualReturn = potentialReturn;
              currentProfit += (actualReturn - stakePerBetslip);
            } else if (groupResult === 'loss') {
              currentProfit -= stakePerBetslip;
            }
            
            stakes.push({
              type: 'betslip',
              groupNumber,
              stake: stakePerBetslip,
              odds: config.odds,
              potentialReturn,
              actualReturn,
              result: groupResult,
              market: 'under6'
            });
            
            if (groupResult !== 'pending') {
              totalStaked += stakePerBetslip;
            }
            totalPotentialReturns += potentialReturn;
          }
        }
      } else {
        const stakePerBet = capital * 0.02;
        
        betslipSelections.forEach((selection, index) => {
          const config = marketConfig[selection.market];
          const potentialReturn = stakePerBet * config.odds;
          const result = selection.result || 'pending';
          
          let actualReturn = 0;
          if (result === 'win') {
            actualReturn = potentialReturn;
            currentProfit += (actualReturn - stakePerBet);
          } else if (result === 'loss') {
            currentProfit -= stakePerBet;
          }
          
          stakes.push({
            type: 'bet',
            betNumber: index + 1,
            stake: stakePerBet,
            odds: config.odds,
            potentialReturn,
            actualReturn,
            result,
            market: selection.market,
            fixture: `${selection.homeTeam} vs ${selection.awayTeam}`
          });
          
          if (result !== 'pending') {
            totalStaked += stakePerBet;
          }
          totalPotentialReturns += potentialReturn;
        });
      }

      const newCapital = capital + currentProfit;

      return { 
        stakes, 
        totalStaked, 
        totalPotentialReturns,
        currentProfit,
        newCapital
      };
    }

    function updateStakeDisplay() {
      const capitalInput = document.getElementById('totalCapital');
      const capital = capitalInput ? parseFloat(capitalInput.value) || 0 : 0;
      const stakeInfo = document.getElementById('stakeInfo');
      const stakeRules = document.getElementById('stakeRules');
      
      if (capital > 0 && currentMarketType && stakeInfo && stakeRules) {
        stakeInfo.classList.remove('hidden');
        
        if (currentMarketType === 'under6') {
          const stakePerBetslip = capital * 0.1;
          stakeRules.innerHTML = `Under 6 Goals: ¬£${stakePerBetslip.toFixed(2)} per betslip (10%)`;
        } else {
          const stakePerBet = capital * 0.02;
          stakeRules.innerHTML = `${marketConfig[currentMarketType].name}: ¬£${stakePerBet.toFixed(2)} per bet (2%)`;
        }
      } else if (stakeInfo) {
        stakeInfo.classList.add('hidden');
      }
    }

    function getBetslipCount() {
      if (!currentMarketType) return 0;
      
      const config = marketConfig[currentMarketType];
      if (config.groupSize) {
        return Math.floor(betslipSelections.length / config.groupSize);
      } else {
        return betslipSelections.length;
      }
    }

    // All betslip functions (same as before but keeping for completeness)
    function selectFixture(fixtureId) {
      const fixture = fixturesData.find(f => f.matchid === fixtureId);
      if (!fixture) {
        console.error('Fixture not found with ID:', fixtureId);
        return;
      }

      selectedFixtureForModal = fixture;
      
      document.getElementById('selectedFixtureInfo').innerHTML = `
        <div class="flex items-center justify-center gap-2 text-white font-medium">
          <span>${fixture.HomeTeam}</span>
          <span class="text-zinc-500">vs</span>
          <span>${fixture.AwayTeam}</span>
        </div>
        <div class="text-xs mt-1 flex items-center justify-center gap-2">
          <span class="px-2 py-1 rounded bg-yellow-600/20 text-yellow-400">${fixture.homeScore} - ${fixture.awayScore}</span>
          <span class="text-zinc-500">${fixture.League}</span>
        </div>
      `;
      
      openMarketModal();
    }

    function openMarketModal() {
      const modal = document.getElementById('marketModal');
      modal.classList.remove('invisible', 'opacity-0');
      modal.classList.add('opacity-100');
      modal.querySelector('div').style.transform = 'scale(1)';
    }

    function closeMarketModal() {
      const modal = document.getElementById('marketModal');
      modal.classList.add('invisible', 'opacity-0');
      modal.classList.remove('opacity-100');
      modal.querySelector('div').style.transform = 'scale(0.95)';
      selectedFixtureForModal = null;
    }

    function addSelectedFixtureToJournal(market) {
      if (!selectedFixtureForModal) return;
      
      addToJournal(selectedFixtureForModal.matchid, market);
      closeMarketModal();
    }

    function addToJournal(fixtureId, market) {
      const fixture = fixturesData.find(f => f.matchid === fixtureId);
      if (!fixture) {
        console.error('Fixture not found for betslip:', fixtureId);
        return;
      }

      if (currentMarketType && currentMarketType !== market) {
        alert(`You can only add fixtures from the same market type. Current market: ${marketConfig[currentMarketType].name}`);
        return;
      }

      if (betslipSelections.find(s => s.fixtureId === fixtureId && s.market === market)) {
        alert('This fixture is already in your betslip');
        return;
      }

      if (!currentMarketType) {
        currentMarketType = market;
        localStorage.setItem('currentMarketType', currentMarketType);
      }

      const config = marketConfig[market];
      if (market !== 'under6' && betslipSelections.length >= config.maxSelections) {
        betslipSelections = [];
      }

      const selection = {
        fixtureId,
        market,
        homeTeam: fixture.HomeTeam,
        awayTeam: fixture.AwayTeam,
        league: fixture.League,
        date: fixture.matchDate,
        finalScore: fixture['final score'],
        homeScore: fixture.homeScore,
        awayScore: fixture.awayScore,
        addedAt: new Date().toISOString()
      };

      betslipSelections.push(selection);
      saveBetslip();
      updateBetslipUI();
      showNotification(`Added ${fixture.HomeTeam} vs ${fixture.AwayTeam} to betslip`);
    }

    function removeFromJournal(fixtureId, market) {
      betslipSelections = betslipSelections.filter(s => !(s.fixtureId === fixtureId && s.market === market));
      
      if (betslipSelections.length === 0) {
        currentMarketType = null;
        localStorage.removeItem('currentMarketType');
      }
      
      saveBetslip();
      updateBetslipUI();
    }

    function saveBetslip() {
      localStorage.setItem('betslipSelections', JSON.stringify(betslipSelections));
    }

    function updateBetslipUI() {
      const count = getBetslipCount();
      const countEl = document.getElementById('betslipCount');
      const totalEl = document.getElementById('totalBetslips');
      const proceedBtn = document.getElementById('proceedToJournal');

      if (countEl) {
        countEl.textContent = count;
        if (count > 0) {
          countEl.classList.remove('opacity-0', 'scale-0');
          countEl.classList.add('opacity-100', 'scale-100');
        } else {
          countEl.classList.add('opacity-0', 'scale-0');
          countEl.classList.remove('opacity-100', 'scale-100');
        }
      }

      if (totalEl) totalEl.textContent = count;
      if (proceedBtn) proceedBtn.disabled = count === 0;

      const { totalStaked, currentProfit, newCapital } = calculateStakeAndReturns();
      
      const stakedEl = document.getElementById('totalStaked');
      const profitEl = document.getElementById('currentProfit');
      const capitalEl = document.getElementById('newCapital');
      
      if (stakedEl) stakedEl.textContent = `¬£${totalStaked.toFixed(2)}`;
      if (profitEl) {
        profitEl.textContent = `¬£${currentProfit.toFixed(2)}`;
        if (currentProfit > 0) {
          profitEl.className = 'text-green-400 font-mono';
        } else if (currentProfit < 0) {
          profitEl.className = 'text-red-400 font-mono';
        } else {
          profitEl.className = 'text-yellow-400 font-mono';
        }
      }
      if (capitalEl) capitalEl.textContent = `¬£${newCapital.toFixed(2)}`;

      renderBetslipSelections();
    }

    function renderBetslipSelections() {
      const container = document.getElementById('betslipSelections');
      const emptyState = document.getElementById('betslipEmpty');

      if (betslipSelections.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        updateStakeDisplay();
        return;
      }

      emptyState.style.display = 'none';

      const { stakes } = calculateStakeAndReturns();
      let html = '';

      if (currentMarketType === 'under6') {
        const config = marketConfig[currentMarketType];
        const groupSize = config.groupSize;
        
        for (let i = 0; i < betslipSelections.length; i += groupSize) {
          const group = betslipSelections.slice(i, i + groupSize);
          const isComplete = group.length === groupSize;
          const groupNumber = Math.floor(i / groupSize) + 1;
          
          const stakeInfo = stakes.find(s => s.groupNumber === groupNumber);
          
          const groupResult = group[0]?.groupResult || 'pending';
          let groupResultBadge = '';
          let stakeDisplay = '';
          
          if (stakeInfo) {
            const stake = stakeInfo.stake;
            const potentialReturn = stakeInfo.potentialReturn;
            const actualReturn = stakeInfo.actualReturn;
            
            stakeDisplay = `
              <div class="mt-2 pt-2 border-t border-zinc-700 text-xs">
                <div class="flex justify-between">
                  <span class="text-zinc-400">Stake:</span>
                  <span class="text-white font-mono">¬£${stake.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-zinc-400">Potential Return:</span>
                  <span class="text-green-400 font-mono">¬£${potentialReturn.toFixed(2)}</span>
                </div>
                ${actualReturn > 0 ? `
                <div class="flex justify-between">
                  <span class="text-zinc-400">Actual Return:</span>
                  <span class="text-green-400 font-mono font-bold">¬£${actualReturn.toFixed(2)}</span>
                </div>` : ''}
              </div>
            `;
          }
          
          switch (groupResult) {
            case 'win':
              groupResultBadge = `<span class="text-xs px-2 py-1 bg-green-600/20 text-green-400 rounded-full border border-green-600/30">BETSLIP WIN</span>`;
              break;
            case 'loss':
              groupResultBadge = `<span class="text-xs px-2 py-1 bg-red-600/20 text-red-400 rounded-full border border-red-600/30">BETSLIP LOSS</span>`;
              break;
            default:
              groupResultBadge = `<span class="text-xs px-2 py-1 bg-yellow-600/20 text-yellow-400 rounded-full border border-yellow-600/30">PENDING</span>`;
          }
          
          html += `
            <div class="betslip-group ${!isComplete ? 'incomplete-betslip' : ''}">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i>
                  <span class="text-sm font-medium text-purple-300">
                    Betslip ${groupNumber}
                  </span>
                  ${!isComplete ? `<span class="text-xs px-2 py-1 bg-orange-600/20 text-orange-400 rounded-full">Incomplete (${group.length}/3)</span>` : groupResultBadge}
                </div>
                ${isComplete ? `<div class="text-sm font-mono text-green-400">Odds: ${config.odds}</div>` : ''}
              </div>
              
              <div class="space-y-2">
                ${group.map(selection => renderSingleSelection(selection)).join('')}
              </div>
              
              ${stakeDisplay}
            </div>
          `;
        }
      } else {
        betslipSelections.forEach((selection, index) => {
          const config = marketConfig[selection.market];
          const stakeInfo = stakes.find(s => s.betNumber === index + 1);
          
          let stakeDisplay = '';
          if (stakeInfo) {
            const stake = stakeInfo.stake;
            const potentialReturn = stakeInfo.potentialReturn;
            const actualReturn = stakeInfo.actualReturn;
            
            stakeDisplay = `
              <div class="mt-2 pt-2 border-t border-zinc-700 text-xs">
                <div class="flex justify-between">
                  <span class="text-zinc-400">Stake:</span>
                  <span class="text-white font-mono">¬£${stake.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-zinc-400">Potential Return:</span>
                  <span class="text-green-400 font-mono">¬£${potentialReturn.toFixed(2)}</span>
                </div>
                ${actualReturn > 0 ? `
                <div class="flex justify-between">
                  <span class="text-zinc-400">Actual Return:</span>
                  <span class="text-green-400 font-mono font-bold">¬£${actualReturn.toFixed(2)}</span>
                </div>` : ''}
              </div>
            `;
          }
          
          html += `
            <div class="betslip-group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-white">${config.name}</span>
                <div class="text-sm font-mono text-green-400">Odds: ${config.odds}</div>
              </div>
              ${renderSingleSelection(selection)}
              ${stakeDisplay}
            </div>
          `;
        });
      }

      container.innerHTML = html;
      updateStakeDisplay();
      
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }
    }

    function renderSingleSelection(selection) {
      const dateStr = new Date(selection.date).toLocaleDateString('en-GB', { 
        weekday: 'short',
        day: 'numeric',
        month: 'short'
      });

      const score = parseFloat(selection.finalScore) || 0;
      let scoreColor = 'text-zinc-400';
      if (score >= 4) scoreColor = 'text-green-400';
      else if (score >= 3) scoreColor = 'text-yellow-400';
      else scoreColor = 'text-red-400';

      const homeScore = selection.homeScore || 0;
      const awayScore = selection.awayScore || 0;
      const actualMatchScore = `${homeScore}-${awayScore}`;

      const result = selection.result || 'pending';
      const totalGoals = selection.totalGoals || 0;
      
      let resultBadge = '';
      switch (result) {
        case 'win':
          resultBadge = `<span class="text-xs px-2 py-1 rounded bg-green-600/20 text-green-400 border border-green-600/30">WIN</span>`;
          break;
        case 'loss':
          resultBadge = `<span class="text-xs px-2 py-1 rounded bg-red-600/20 text-red-400 border border-red-600/30">LOSS</span>`;
          break;
        default:
          resultBadge = `<span class="text-xs px-2 py-1 rounded bg-yellow-600/20 text-yellow-400 border border-yellow-600/30">PENDING</span>`;
      }

      return `
        <div class="betslip-selection">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="text-xs font-mono px-2 py-1 rounded text-white bg-zinc-700 border border-zinc-600">
                ${actualMatchScore}
              </div>
              <div class="text-xs font-mono px-2 py-1 rounded text-blue-400 bg-blue-600/10 border border-blue-600/20">
                ${totalGoals}G
              </div>
              ${resultBadge}
              <span class="text-xs text-zinc-500">${dateStr}</span>
            </div>
            <button onclick="removeFromJournal('${selection.fixtureId}', '${selection.market}')" class="text-zinc-400 hover:text-red-400 transition-colors">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
          
          <div class="text-sm text-white font-medium mb-1">
            ${selection.homeTeam} vs ${selection.awayTeam}
          </div>
          
          <div class="flex items-center justify-between">
            <span class="text-xs text-zinc-400">${selection.league}</span>
            <div class="flex items-center gap-1">
              <div class="text-xs font-mono px-2 py-1 rounded ${scoreColor} bg-opacity-10 border border-current border-opacity-20">
                Rating: ${selection.finalScore}
              </div>
              <span class="text-xs px-2 py-1 rounded-full ${getMarketBadgeClass(selection.market)}">
                ${marketConfig[selection.market].name}
              </span>
            </div>
          </div>
        </div>
      `;
    }

    function getMarketBadgeClass(market) {
      switch (market) {
        case 'over2.5': return 'bg-yellow-600/20 text-yellow-400';
        case 'under2.5': return 'bg-indigo-600/20 text-indigo-400';
        case 'under6': return 'bg-purple-600/20 text-purple-400';
        default: return 'bg-zinc-600/20 text-zinc-400';
      }
    }

    function openBetslip() {
      document.getElementById('betslipSidebar').style.transform = 'translateX(0)';
      document.getElementById('betslipOverlay').classList.remove('invisible', 'opacity-0');
      document.getElementById('betslipOverlay').classList.add('opacity-100');
    }

    function closeBetslip() {
      document.getElementById('betslipSidebar').style.transform = 'translateX(100%)';
      document.getElementById('betslipOverlay').classList.add('invisible', 'opacity-0');
      document.getElementById('betslipOverlay').classList.remove('opacity-100');
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-[slideInUp_0.3s_ease-out]';
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // üîí SECURE: Update scores with authentication
    async function updateBetslipScores() {
      if (betslipSelections.length === 0) {
        showNotification('No fixtures in betslip to update');
        return;
      }

      try {
        // üîí Make authenticated request to secure API
        const response = await makeAuthenticatedRequest('https://api-7wyko6woyq-uc.a.run.app/calculator/fixtures', {
          cache: 'no-cache' 
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to update scores');
        }

        const freshData = data.fixtures;

        let updatedCount = 0;
        betslipSelections = betslipSelections.map(selection => {
          const freshFixture = freshData.find(f => String(f.matchid) === String(selection.fixtureId));
          if (freshFixture) {
            const newHomeScore = parseInt(freshFixture.FTHG) || 0;
            const newAwayScore = parseInt(freshFixture.FTAG) || 0;
            const totalGoals = parseFloat(freshFixture.ftgoals) || 0;
            
            let result = 'pending';
            if (totalGoals > 0) {
              switch (selection.market) {
                case 'over2.5':
                  result = totalGoals > 2.5 ? 'win' : 'loss';
                  break;
                case 'under2.5':
                  result = totalGoals <= 2.5 ? 'win' : 'loss';
                  break;
                case 'under6':
                  result = totalGoals < 6 ? 'win' : 'loss';
                  break;
                default:
                  result = 'pending';
              }
            }
            
            if (selection.homeScore !== newHomeScore || selection.awayScore !== newAwayScore || selection.result !== result) {
              updatedCount++;
            }
            
            return {
              ...selection,
              homeScore: newHomeScore,
              awayScore: newAwayScore,
              totalGoals: totalGoals,
              result: result
            };
          }
          return selection;
        });

        // For under6 market, calculate betslip-level results
        if (currentMarketType === 'under6') {
          const groupSize = marketConfig['under6'].groupSize;
          for (let i = 0; i < betslipSelections.length; i += groupSize) {
            const group = betslipSelections.slice(i, i + groupSize);
            if (group.length === groupSize) {
              const allWin = group.every(selection => selection.result === 'win');
              const anyLoss = group.some(selection => selection.result === 'loss');
              const anyPending = group.some(selection => selection.result === 'pending');
              
              let groupResult = 'pending';
              if (anyPending) {
                groupResult = 'pending';
              } else if (allWin) {
                groupResult = 'win';
              } else if (anyLoss) {
                groupResult = 'loss';
              }
              
              for (let j = i; j < i + groupSize && j < betslipSelections.length; j++) {
                betslipSelections[j].groupResult = groupResult;
              }
            }
          }
        }

        saveBetslip();
        updateBetslipUI();
        
        showNotification(`üîí Updated ${updatedCount} fixture scores & results (authenticated)`);
        
      } catch (error) {
        console.error('Error updating scores:', error);
        if (error.message === 'Authentication required') {
          showNotification('‚ö†Ô∏è Authentication required - please sign in');
        } else {
          showNotification('Error updating scores - check console');
        }
      }
    }

    // Check for URL parameters from backtesting page (same as before)
    function checkUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const teams = urlParams.get('teams');
      const market = urlParams.get('market');
      const source = urlParams.get('source');

      if (teams && market && source === 'backtesting') {
        selectedTeams = teams.split(',').map(team => team.trim());
        selectedMarket = market;
        isFiltered = true;

        console.log('URL Parameters:', { selectedTeams, selectedMarket, source });

        const marketNames = {
          'over2.5': 'OVER 2.5 GOALS',
          'under2.5': 'UNDER 2.5 GOALS',
          'under6': 'UNDER 6 GOALS'
        };
        
        document.getElementById('filterStatus').style.display = 'block';
        document.getElementById('currentMarket').textContent = marketNames[selectedMarket] || selectedMarket.toUpperCase();
      }
    }

    function buildTeamList() {
      allTeams.clear();
      fixturesData.forEach(fixture => {
        if (fixture.HomeTeam && fixture.HomeTeam !== 'TBA') {
          allTeams.add(fixture.HomeTeam);
        }
        if (fixture.AwayTeam && fixture.AwayTeam !== 'TBA') {
          allTeams.add(fixture.AwayTeam);
        }
      });
      
      console.log(`Found ${allTeams.size} unique teams in fixtures data`);
      populateTeamOptions();
    }

    function populateTeamOptions() {
      const container = document.getElementById('teamOptions');
      const teams = Array.from(allTeams).sort();
      
      let html = '';
      
      html += `
        <label class="flex items-center px-3 py-2 hover:bg-[#141b23] cursor-pointer">
          <input type="checkbox" id="selectAll" class="rounded border-zinc-700 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0 w-4 h-4 bg-[#0b1016] mr-2">
          <span class="text-sm text-zinc-300 font-medium">Select All Teams</span>
        </label>
        <div class="h-px bg-zinc-800 mx-2 my-1"></div>
      `;
      
      teams.forEach(team => {
        html += `
          <label class="flex items-center px-3 py-2 hover:bg-[#141b23] cursor-pointer team-option" data-team="${team}">
            <input type="checkbox" value="${team}" class="team-checkbox rounded border-zinc-700 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0 w-4 h-4 bg-[#0b1016] mr-2">
            <span class="text-sm text-zinc-300">${team}</span>
          </label>
        `;
      });
      
      container.innerHTML = html;
      
      if (isFiltered && selectedTeams.length > 0) {
        selectedTeams.forEach(urlTeam => {
          teams.forEach(team => {
            if (teamMatches(team, urlTeam)) {
              userSelectedTeams.add(team);
              const checkbox = container.querySelector(`input[value="${team}"]`);
              if (checkbox) checkbox.checked = true;
            }
          });
        });
        updateSelectedTeamsDisplay();
      }
    }

    function updateSelectedTeamsDisplay() {
      const display = document.getElementById('selectedTeamsDisplay');
      const count = document.getElementById('selectedCount');
      const text = document.getElementById('selectedTeamsText');
      const badge = document.getElementById('filterBadge');
      
      count.textContent = userSelectedTeams.size;
      
      if (userSelectedTeams.size === 0) {
        display.innerHTML = '<span class="text-zinc-500">No teams selected</span>';
        text.textContent = 'All Teams';
        badge.classList.add('hidden');
      } else {
        const teamTags = Array.from(userSelectedTeams).map(team => 
          `<span class="inline-flex items-center gap-1 bg-yellow-600/10 text-yellow-400 border border-yellow-600/20 rounded px-2 py-1 text-xs">
            ${team}
            <button onclick="removeTeam('${team}')" class="text-yellow-500 hover:text-yellow-300">
              <i data-lucide="x" class="w-3 h-3"></i>
            </button>
          </span>`
        ).join(' ');
        
        display.innerHTML = teamTags;
        text.textContent = userSelectedTeams.size === 1 ? 
          Array.from(userSelectedTeams)[0] : 
          `${userSelectedTeams.size} teams selected`;
        
        badge.classList.remove('hidden');
        
        if (window.lucide) {
          window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
        }
      }
    }

    function toggleFilterSection() {
      const content = document.getElementById('filterContent');
      const chevron = document.getElementById('filterChevron');
      
      if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
        content.style.maxHeight = '500px';
        content.style.opacity = '1';
        content.style.paddingTop = '1rem';
        content.style.paddingBottom = '1rem';
        chevron.style.transform = 'rotate(180deg)';
        
        localStorage.setItem('filterSectionExpanded', 'true');
      } else {
        content.style.maxHeight = '0px';
        content.style.opacity = '0';
        content.style.paddingTop = '0';
        content.style.paddingBottom = '0';
        chevron.style.transform = 'rotate(0deg)';
        
        localStorage.setItem('filterSectionExpanded', 'false');
      }
    }

    function initializeFilterSection() {
      const content = document.getElementById('filterContent');
      const chevron = document.getElementById('filterChevron');
      
      const isExpanded = localStorage.getItem('filterSectionExpanded') === 'true';
      
      if (isExpanded) {
        content.style.maxHeight = '500px';
        content.style.opacity = '1';
        content.style.paddingTop = '1rem';
        content.style.paddingBottom = '1rem';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        content.style.maxHeight = '0px';
        content.style.opacity = '0';
        content.style.paddingTop = '0';
        content.style.paddingBottom = '0';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    function removeTeam(team) {
      userSelectedTeams.delete(team);
      const checkbox = document.querySelector(`input[value="${team}"]`);
      if (checkbox) checkbox.checked = false;
      updateSelectedTeamsDisplay();
    }

    // üîí SECURE: Load fixtures with authentication
    async function loadFixtures() {
      try {
        // üîí Make authenticated request to secure API
        const response = await makeAuthenticatedRequest('https://api-7wyko6woyq-uc.a.run.app/calculator/fixtures', {
          cache: 'no-cache' 
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load fixtures');
        }

        fixturesData = data.fixtures;
        console.log(`üîí Loaded ${fixturesData.length} fixtures from authenticated API`);
        
        processFixturesData();
        buildTeamList();
        applyFiltering();
        
        if (isFiltered && userSelectedTeams.size > 0) {
          renderBetslips();
        } else {
          renderFixtures();
        }
        
        updateStats();
        hideLoading();
        updateLastUpdated();
        updateBetslipUI();
      } catch (error) {
        console.error('Error loading fixtures:', error);
        if (error.message === 'Authentication required') {
          showAuthRequired();
        } else {
          showError();
        }
      }
    }

    function processFixturesData() {
      fixturesData = fixturesData.map((fixture, index) => {
        const matchid = String(fixture.matchid || `fallback_${index}_${Date.now()}`);

        let matchDate = new Date();
        if (fixture.Date) {
          const dateStr = String(fixture.Date).trim();
          if (dateStr && dateStr !== 'Invalid Date') {
            const parts = dateStr.split(' ');
            const datePart = parts[0];
            const timePart = fixture.Location || '00:00';
            
            if (datePart.includes('/')) {
              const [day, month, year] = datePart.split('/');
              const [hour, minute] = timePart.split(':');
              
              const parsedDate = new Date(
                parseInt(year), 
                parseInt(month) - 1,
                parseInt(day),
                parseInt(hour) || 0,
                parseInt(minute) || 0
              );
              
              if (!isNaN(parsedDate.getTime())) {
                matchDate = parsedDate;
              }
            } else {
              const parsedDate = new Date(dateStr);
              if (!isNaN(parsedDate.getTime())) {
                matchDate = parsedDate;
              }
            }
          }
        }

        const homeTeam = fixture['Home Team'] || fixture.HomeTeam || 'TBA';
        const awayTeam = fixture['Away Team'] || fixture.AwayTeam || 'TBA';
        const league = fixture.league || fixture.League || 'Unknown League';
        
        let homeScore = parseInt(fixture.FTHG) || 0;
        let awayScore = parseInt(fixture.FTAG) || 0;

        let status = 'upcoming';
        const now = new Date();
        
        if (fixture.Status) {
          const statusLower = fixture.Status.toLowerCase();
          if (statusLower.includes('live') || statusLower.includes('ht') || statusLower.includes("'")) {
            status = 'live';
          } else if (statusLower.includes('ft') || statusLower.includes('finished') || statusLower.includes('final')) {
            status = 'finished';
          } else if (statusLower.includes('postponed') || statusLower.includes('cancelled')) {
            status = 'postponed';
          }
        } else if (matchDate < now && (homeScore > 0 || awayScore > 0)) {
          status = 'finished';
        } else if (matchDate < now) {
          status = 'finished';
        }

        return {
          ...fixture,
          matchid,
          matchDate,
          status,
          homeScore,
          awayScore,
          HomeTeam: homeTeam,
          AwayTeam: awayTeam,
          League: league,
          Round: fixture.Round || '',
          Location: fixture.Location || ''
        };
      });

      fixturesData.sort((a, b) => a.matchDate - b.matchDate);
    }

    function applyFiltering() {
      if (userSelectedTeams.size > 0) {
        filteredFixtures = fixturesData.filter(fixture => {
          return Array.from(userSelectedTeams).some(selectedTeam => 
            teamMatches(fixture.HomeTeam, selectedTeam) || 
            teamMatches(fixture.AwayTeam, selectedTeam)
          );
        });
        
        console.log(`Filtered ${filteredFixtures.length} fixtures from ${fixturesData.length} total fixtures for teams:`, Array.from(userSelectedTeams));
        
        isFiltered = true;
        document.getElementById('filterStatus').style.display = 'block';
      } else {
        filteredFixtures = fixturesData;
        isFiltered = false;
        document.getElementById('filterStatus').style.display = 'none';
      }
    }

    function applyTeamFilter() {
      applyFiltering();
      
      if (userSelectedTeams.size > 0) {
        renderBetslips();
      } else {
        renderFixtures();
      }
      
      updateStats();
      
      document.getElementById('teamFilterMenu').classList.add('hidden');
    }

    function renderBetslips() {
      const container = document.getElementById('betslipsContainer');
      const fixturesContainer = document.getElementById('fixturesContainer');
      const emptyState = document.getElementById('emptyState');

      fixturesContainer.style.display = 'none';
      container.style.display = 'block';

      if (filteredFixtures.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      const betslips = groupFixturesByWeeks(filteredFixtures);

      if (betslips.length === 0) {
        emptyState.style.display = 'block';
        return;
      }

      let html = '';

      betslips.forEach((betslip, index) => {
        const weekStart = new Date(betslip.weekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const weekLabel = `Week ${index + 1} (${weekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })})`;

        const marketIcon = selectedMarket === 'under6' ? 'trending-down' : 
                          selectedMarket === 'under2.5' ? 'trending-down' : 'trending-up';
        const marketColor = selectedMarket === 'under6' ? 'text-purple-400' : 
                           selectedMarket === 'under2.5' ? 'text-indigo-400' : 'text-yellow-400';

        html += `
          <div class="betslip-card rounded-xl p-6 border border-purple-900/40">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-purple-600/10 ring-1 ring-purple-600/20">
                  <i data-lucide="${marketIcon}" class="w-4 h-4 ${marketColor}"></i>
                </span>
                <div>
                  <h3 class="text-lg font-semibold text-white">${weekLabel}</h3>
                  <div class="text-sm text-zinc-400">${selectedMarket ? selectedMarket.replace(/([A-Z])/g, ' $1').toUpperCase() : 'MIXED'} Accumulator</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm text-zinc-400">Fixtures</div>
                <div class="text-xl font-mono font-bold text-purple-400">${betslip.fixtures.length}</div>
              </div>
            </div>

            <div class="space-y-3">
              ${betslip.fixtures.map(fixture => renderBetslipFixture(fixture)).join('')}
            </div>

            <div class="mt-4 pt-3 border-t border-zinc-800">
              <div class="flex items-center justify-between text-sm">
                <span class="text-zinc-500">Accumulator ${selectedMarket === 'under6' ? '(All fixtures must be under 6 goals)' : selectedMarket === 'under2.5' ? '(All fixtures must be under 2.5 goals)' : selectedMarket === 'over2.5' ? '(All fixtures must be over 2.5 goals)' : ''}</span>
                <span class="text-purple-400 font-medium">Week ${index + 1}</span>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }
    }

    function groupFixturesByWeeks(fixtures) {
      const betslips = [];
      
      const fixturesByWeek = {};
      
      fixtures.forEach(fixture => {
        const date = new Date(fixture.matchDate);
        const dayOfWeek = date.getDay();
        const monday = new Date(date);
        monday.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        monday.setHours(0, 0, 0, 0);
        
        const weekKey = monday.toISOString().split('T')[0];
        
        if (!fixturesByWeek[weekKey]) {
          fixturesByWeek[weekKey] = [];
        }
        fixturesByWeek[weekKey].push(fixture);
      });

      Object.entries(fixturesByWeek).forEach(([weekStart, weekFixtures]) => {
        const weekFixturesList = weekFixtures.sort((a, b) => a.matchDate - b.matchDate);
        
        if (weekFixturesList.length > 0) {
          betslips.push({
            weekStart,
            fixtures: weekFixturesList
          });
        }
      });

      return betslips.sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
    }

    function renderBetslipFixture(fixture) {
      const timeStr = fixture.matchDate.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      const dateStr = fixture.matchDate.toLocaleDateString('en-GB', { 
        weekday: 'short',
        day: 'numeric',
        month: 'short'
      });

      const finalScore = fixture['final score'] || 0;
      let scoreColor = 'text-zinc-400';
      if (finalScore >= 4) scoreColor = 'text-green-400';
      else if (finalScore >= 3) scoreColor = 'text-yellow-400';
      else scoreColor = 'text-red-400';

      let statusBadge = '';
      let scoreDisplay = '';
      
      switch (fixture.status) {
        case 'live':
          statusBadge = `<span class="status-live px-2 py-1 text-xs font-medium border rounded">${fixture.Status || 'LIVE'}</span>`;
          scoreDisplay = `<div class="text-sm font-mono font-bold text-white">${fixture.homeScore} - ${fixture.awayScore}</div>`;
          break;
        case 'finished':
          statusBadge = `<span class="status-finished px-2 py-1 text-xs font-medium border rounded">FT</span>`;
          scoreDisplay = `<div class="text-sm font-mono font-bold text-white">${fixture.homeScore} - ${fixture.awayScore}</div>`;
          break;
        case 'postponed':
          statusBadge = `<span class="status-postponed px-2 py-1 text-xs font-medium border rounded">POSTPONED</span>`;
          scoreDisplay = `<div class="text-xs text-zinc-500">vs</div>`;
          break;
        default:
          statusBadge = `<span class="status-upcoming px-2 py-1 text-xs font-medium border rounded">${timeStr}</span>`;
          scoreDisplay = `<div class="text-xs text-zinc-500">vs</div>`;
      }

      const isInBetslip = betslipSelections.find(s => s.fixtureId === fixture.matchid);

      return `
        <div class="bg-[#111821] border border-zinc-800 rounded-lg p-3 cursor-pointer hover:border-zinc-700 transition-all" onclick="selectFixture('${fixture.matchid}')">
          <div class="flex items-center justify-between mb-2">
            
            <div class="flex items-center gap-2">
              <div class="text-xs font-mono px-2 py-1 rounded ${scoreColor} bg-opacity-10 border border-current border-opacity-20">
                Score: ${finalScore}
              </div>
              ${isInBetslip ? `<span class="text-xs px-2 py-1 bg-green-600/20 text-green-400 rounded-full">Added</span>` : ''}
            </div>

            <div class="text-xs text-zinc-500">
              ${dateStr}
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div class="flex-1 grid grid-cols-[1fr_auto_1fr] items-center gap-3">
              
              <div class="text-right">
                <div class="text-sm font-medium text-white truncate">${fixture.HomeTeam}</div>
              </div>

              <div class="text-center">
                ${scoreDisplay}
                ${statusBadge}
              </div>

              <div class="text-left">
                <div class="text-sm font-medium text-white truncate">${fixture.AwayTeam}</div>
              </div>

            </div>

            <div class="ml-4 text-zinc-400">
              <i data-lucide="plus-circle" class="w-5 h-5"></i>
            </div>
          </div>
        </div>
      `;
    }

    function renderFixtures() {
      const container = document.getElementById('fixturesContainer');
      const betslipsContainer = document.getElementById('betslipsContainer');
      const emptyState = document.getElementById('emptyState');

      betslipsContainer.style.display = 'none';
      container.style.display = 'block';

      if (filteredFixtures.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      const fixturesByLeague = {};
      filteredFixtures.forEach(fixture => {
        const league = fixture.League || 'Unknown League';
        if (!fixturesByLeague[league]) {
          fixturesByLeague[league] = [];
        }
        fixturesByLeague[league].push(fixture);
      });

      let html = '';

      Object.keys(fixturesByLeague).forEach(league => {
        const fixtures = fixturesByLeague[league];
        
        html += `
          <div class="league-section">
            <div class="league-header flex items-center gap-3 py-3 px-4 mb-4">
              ${getLeagueFlagHTML(league)}
              <h2 class="text-lg font-semibold text-white">${league}</h2>
              <span class="text-xs text-zinc-500 bg-[#111821] border border-zinc-800 px-2 py-1 rounded">${fixtures.length} matches</span>
            </div>
            
            <div class="space-y-3 mb-8">
              ${fixtures.map(fixture => renderFixtureCard(fixture)).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }
    }

    function renderFixtureCard(fixture) {
      const timeStr = fixture.matchDate.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });

      const finalScore = fixture['final score'] || 0;
      let scoreColor = 'text-zinc-400';
      if (finalScore >= 4) scoreColor = 'text-green-400';
      else if (finalScore >= 3) scoreColor = 'text-yellow-400';
      else scoreColor = 'text-red-400';

      let statusBadge = '';
      let scoreDisplay = '';
      
      switch (fixture.status) {
        case 'live':
          statusBadge = `<span class="status-live px-2 py-1 text-xs font-medium border rounded">${fixture.Status || 'LIVE'}</span>`;
          scoreDisplay = `<div class="text-lg font-mono font-bold text-white">${fixture.homeScore} - ${fixture.awayScore}</div>`;
          break;
        case 'finished':
          statusBadge = `<span class="status-finished px-2 py-1 text-xs font-medium border rounded">FT</span>`;
          scoreDisplay = `<div class="text-lg font-mono font-bold text-white">${fixture.homeScore} - ${fixture.awayScore}</div>`;
          break;
        case 'postponed':
          statusBadge = `<span class="status-postponed px-2 py-1 text-xs font-medium border rounded">POSTPONED</span>`;
          scoreDisplay = `<div class="text-sm text-zinc-500">vs</div>`;
          break;
        default:
          statusBadge = `<span class="status-upcoming px-2 py-1 text-xs font-medium border rounded">${timeStr}</span>`;
          scoreDisplay = `<div class="text-sm text-zinc-500">vs</div>`;
      }

      const isInBetslip = betslipSelections.find(s => s.fixtureId === fixture.matchid);

      return `
        <div class="fixture-card bg-[#0f141b] border border-zinc-900/60 rounded-lg p-4 hover:border-yellow-600/30 cursor-pointer transition-all" onclick="selectFixture('${fixture.matchid}')">
          <div class="flex items-center justify-between mb-2">
            
            <div class="flex items-center gap-2">
              <div class="text-xs font-mono px-2 py-1 rounded ${scoreColor} bg-opacity-10 border border-current border-opacity-20">
                Score: ${finalScore}
              </div>
              ${isInBetslip ? `<span class="text-xs px-2 py-1 bg-green-600/20 text-green-400 rounded-full">Added</span>` : ''}
            </div>

            <div class="flex items-center gap-2">
              ${fixture.Round ? `<span class="text-xs text-zinc-500 bg-[#111821] border border-zinc-800 px-2 py-1 rounded">${fixture.Round}</span>` : ''}
              <div class="text-zinc-400">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-center">
            <div class="flex-1 grid grid-cols-[1fr_auto_1fr] items-center gap-4">
              
              <div class="text-right">
                <div class="text-sm font-medium text-white truncate">${fixture.HomeTeam || 'TBA'}</div>
              </div>

              <div class="text-center">
                ${scoreDisplay}
                ${statusBadge}
              </div>

              <div class="text-left">
                <div class="text-sm font-medium text-white truncate">${fixture.AwayTeam || 'TBA'}</div>
              </div>

            </div>
          </div>

          <div class="text-center mt-2">
            <span class="text-xs text-zinc-500">üîí Click to add to betslip (authenticated)</span>
          </div>
        </div>
      `;
    }

    function updateStats() {
      const totalFixtures = filteredFixtures.length;
      const completedFixtures = filteredFixtures.filter(f => f.status === 'finished').length;

      document.getElementById('totalFixtures').textContent = totalFixtures;
      document.getElementById('completedFixtures').textContent = completedFixtures;
      document.getElementById('fixtureCount').textContent = totalFixtures;

      if (userSelectedTeams.size > 0) {
        const betslips = groupFixturesByWeeks(filteredFixtures);
        const uniqueTeams = new Set([...filteredFixtures.map(f => f.HomeTeam), ...filteredFixtures.map(f => f.AwayTeam)]).size;
        
        document.getElementById('weeklyBetslips').textContent = betslips.length;
        document.getElementById('uniqueTeams').textContent = uniqueTeams;
        
        document.querySelector('#weeklyBetslips').parentElement.querySelector('.text-zinc-400').textContent = 'Weekly Betslips';
        document.querySelector('#uniqueTeams').parentElement.querySelector('.text-zinc-400').textContent = 'Teams';
      } else {
        const uniqueLeagues = new Set(filteredFixtures.map(f => f.League)).size;
        document.getElementById('weeklyBetslips').textContent = '0';
        document.getElementById('uniqueTeams').textContent = uniqueLeagues;
        
        document.querySelector('#weeklyBetslips').parentElement.querySelector('.text-zinc-400').textContent = 'Live Now';
        document.querySelector('#uniqueTeams').parentElement.querySelector('.text-zinc-400').textContent = 'Leagues';
      }
    }

    function updateLastUpdated() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      document.getElementById('lastUpdated').textContent = `Updated ${timeStr}`;
    }

    function clearFilter() {
      userSelectedTeams.clear();
      selectedTeams = [];
      selectedMarket = '';
      isFiltered = false;
      
      document.querySelectorAll('.team-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAll').checked = false;
      
      updateSelectedTeamsDisplay();
      
      const url = new URL(window.location);
      url.searchParams.delete('teams');
      url.searchParams.delete('market');
      url.searchParams.delete('source');
      window.history.replaceState({}, '', url);
      
      applyFiltering();
      renderFixtures();
      updateStats();
    }

    function filterTeamOptions(searchTerm) {
      const options = document.querySelectorAll('.team-option');
      const lowerSearchTerm = searchTerm.toLowerCase();
      
      options.forEach(option => {
        const teamName = option.dataset.team.toLowerCase();
        if (teamName.includes(lowerSearchTerm)) {
          option.style.display = 'flex';
        } else {
          option.style.display = 'none';
        }
      });
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'none';
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('authRequired').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    // üîí MAIN INITIALIZATION WITH AUTHENTICATION
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.lucide) {
        window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      }

      // üîí STEP 1: Check authentication first
      const isAuthenticated = await checkAuthentication();
      
      if (!isAuthenticated) {
        return; // Stop here if not authenticated
      }

      // üîí STEP 2: Continue with app initialization only if authenticated
      checkUrlParameters();
      initializeFilterSection();

      // All existing event listeners (same as before)
      document.getElementById('toggleFilter').addEventListener('click', toggleFilterSection);

      document.getElementById('teamFilterBtn').addEventListener('click', () => {
        document.getElementById('teamFilterMenu').classList.toggle('hidden');
      });

      document.addEventListener('click', (e) => {
        const btn = document.getElementById('teamFilterBtn');
        const menu = document.getElementById('teamFilterMenu');
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add('hidden');
        }
        
        // Close user menu when clicking outside
        const userBtn = document.getElementById('userMenuBtn');
        const userMenu = document.getElementById('userMenu');
        if (!userBtn.contains(e.target) && !userMenu.contains(e.target)) {
          userMenu.classList.add('hidden');
        }
      });

      // üîí User menu toggle
      document.getElementById('userMenuBtn').addEventListener('click', () => {
        document.getElementById('userMenu').classList.toggle('hidden');
      });

      document.getElementById('teamSearch').addEventListener('input', (e) => {
        filterTeamOptions(e.target.value);
      });

      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('team-checkbox')) {
          const team = e.target.value;
          if (e.target.checked) {
            userSelectedTeams.add(team);
          } else {
            userSelectedTeams.delete(team);
            document.getElementById('selectAll').checked = false;
          }
          updateSelectedTeamsDisplay();
        } else if (e.target.id === 'selectAll') {
          const checkboxes = document.querySelectorAll('.team-checkbox');
          if (e.target.checked) {
            checkboxes.forEach(cb => {
              cb.checked = true;
              userSelectedTeams.add(cb.value);
            });
          } else {
            checkboxes.forEach(cb => {
              cb.checked = false;
              userSelectedTeams.delete(cb.value);
            });
            userSelectedTeams.clear();
          }
          updateSelectedTeamsDisplay();
        }
      });

      document.getElementById('applyFilter').addEventListener('click', applyTeamFilter);
      document.getElementById('clearAllTeams').addEventListener('click', () => {
        userSelectedTeams.clear();
        document.querySelectorAll('.team-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
        updateSelectedTeamsDisplay();
      });
      document.getElementById('clearFilter').addEventListener('click', clearFilter);

      document.getElementById('betslipBtn').addEventListener('click', openBetslip);
      document.getElementById('closeBetslip').addEventListener('click', closeBetslip);
      document.getElementById('betslipOverlay').addEventListener('click', closeBetslip);
      document.getElementById('updateScores').addEventListener('click', updateBetslipScores);
      
      document.getElementById('totalCapital').addEventListener('input', () => {
        updateBetslipUI();
      });

      document.getElementById('marketModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('marketModal')) {
          closeMarketModal();
        }
      });

      document.getElementById('proceedToJournal').addEventListener('click', () => {
        const betslipCount = getBetslipCount();
        if (betslipCount > 0) {
          showNotification(`üîí ${betslipCount} betslip(s) saved to journal! (authenticated)`);
          betslipSelections = [];
          currentMarketType = null;
          localStorage.removeItem('betslipSelections');
          localStorage.removeItem('currentMarketType');
          updateBetslipUI();
          closeBetslip();
        }
      });

      document.querySelector('nav button[data-nav="markets"]')?.addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/market.html';
      });
      
      document.querySelector('nav button[data-nav="backtesting"]')?.addEventListener('click', () => {
        window.location.href = 'backtesting.html';
      });
      
      document.querySelector('nav button[data-nav="journal"]')?.addEventListener('click', () => {
        window.location.href = 'https://www.simplififootball.com/dash.html';
      });

      // üîí STEP 3: Load fixtures data (only if authenticated)
      loadFixtures();
    });
  </script>

</body>
</html>
